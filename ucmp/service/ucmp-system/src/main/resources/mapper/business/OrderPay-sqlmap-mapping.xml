<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.exp.ucmp.pay.dao.OrderPayDao">
	<select id="queryOrderInfo" resultType="com.exp.ucmp.salesDelivery.dto.OrderPaymentInfoDto">
	select
		toi.order_info_id orderInfoId,
		toi.order_no orderNo,
		toi.receivable_price receivablePrice,
		toi.received_price receivedPrice,
		toi.not_received_price notReceivedPrice,
		td.dict_value revertBody,
		toi.financial_loan financialAmount,
		tsi.stock_id stockId
	from
		t_psi_order_info toi
	left join t_psi_car_stock_info tsi on toi.stock_id = tsi.stock_id
	left join t_sys_datadict td on tsi.revert_body = td.dict_code
	where
		1 = 1
		<if test="recordId !=null">
		and toi .order_info_id = ( select tpr.order_info_id from t_psi_sales_payment_record tpr where tpr.record_id = #{recordId})
		</if>
		<if test="orderId !=null">
		and toi .order_info_id = #{orderId}
		</if>
		<if test="recordCode !=null and recordCode !=''">
		and toi .order_info_id = ( select distinct tpr.order_info_id from t_psi_sales_payment_record tpr where tpr.record_code = #{recordCode})
		</if>
	</select>
	
	<update id="updateOrderInfo">
		update
			t_psi_order_info toi
		set
			<if test="paymentItem == '6701' ">
				toi.order_status = '7402',
				<if test="payStatus == '2801'">
				toi.intention_pay_sum = #{amount},
				</if>
				<if test="payStatus == '2804'">
				toi.intention_pay_sum = toi.intention_pay_sum-#{amount},
				</if>
				<if test="payTime != null ">
				toi.intention_pay_time = STR_TO_DATE(#{payTime},'%Y-%m-%d %H:%i:%S'),
				</if>
				<if test="payTime == null ">
				toi.intention_pay_time = now(),
				</if>
			</if>
			<if test="paymentItem == '6702'">
				<if test="payStatus == '2801'">
				toi.set_payment_sum = #{amount},
				</if>
				<if test="payStatus == '2804'">
				toi.set_payment_sum = toi.set_payment_sum-#{amount},
				</if>
				<if test="payTime != null ">
				toi.set_payment_time = STR_TO_DATE(#{payTime},'%Y-%m-%d %H:%i:%S'),
				</if>
				<if test="payTime == null ">
				toi.set_payment_time = now(),
				</if>
			</if>
			<if test="paymentItem =='6703'">
				<if test="payStatus == '2801'">
				toi.balance_payment_sum = #{amount},
				</if>
				<if test="payStatus == '2804'">
				toi.balance_payment_sum = toi.balance_payment_sum-#{amount},
				</if>
				<if test="payTime != null ">
				toi.balance_payment_time = STR_TO_DATE(#{payTime},'%Y-%m-%d %H:%i:%S'),
				</if>
				<if test="payTime == null">
				toi.balance_payment_time = now(),
				</if>
			</if>
			<if test="paymentItem =='6704'">
				<if test="payStatus == '2801'">
				toi.other_payments = #{amount},
				</if>
				<if test="payStatus == '2804'">
				toi.other_payments = toi.other_payments-#{amount},
				</if>
			</if>
			<if test="notReceivedPrice == 0">
				toi.order_status = '7404',
			</if>
			<if test="receivedPrice !=null">
			toi.received_price = #{receivedPrice},
			</if>
			<if test="notReceivedPrice != null">
			toi.not_received_price = #{notReceivedPrice},
			</if>
			toi.updated_by = #{partyId},
			toi.updated_date = now()
		where
			toi.order_info_id = #{orderInfoId}
	</update>
	
	<insert id="bankTransferStatement" parameterType="com.exp.ucmp.sap.dto.SapBankTransferStatementDto">
		insert
			into
				t_sys_bank_transfer_statement ( zbiiln,
				bukrs,
				zpwbankn,
				zpwname,
				zdbankn,
				zdname,
				ztrdate,
				ztrtime,
				zcrtrsamt,
				waers,
				ztext,
				matching_amount,
				created_by,
				created_date,
				updated_by,
				updated_date )
			values( #{zbiiln, jdbcType=VARCHAR},
			#{bukrs, jdbcType=VARCHAR},
			#{zpwbankn, jdbcType=VARCHAR},
			#{zpwname, jdbcType=VARCHAR},
			#{zdbankn, jdbcType=VARCHAR},
			#{zdname, jdbcType=VARCHAR},
			#{ztrdate, jdbcType=VARCHAR},
			#{ztrtime, jdbcType=VARCHAR},
			#{zcrtrsamt, jdbcType=VARCHAR},
			#{waers, jdbcType=VARCHAR},
			#{ztext, jdbcType=VARCHAR},
			#{zcrtrsamt, jdbcType=VARCHAR},
			-999,
			now(),
			-999,
			now() )
	</insert>
	
	<select id="queryPaymentRecordInfo" resultType="com.exp.ucmp.pay.dto.QueryOrderInfoDto">
	select * from (
		select
			toi.order_no orderNum,
			toi.delivery_store deliveryStore,
			tsi.org_name deliveryStoreName,
			tspr.record_code recordCode,
			tspr.payment_item paymentItem,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tspr.payment_item) paymentItemName,
			tspr.pay_status payStatus,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tspr.pay_status)payStatusName,
			tfmr.approval_operation approvalOperation,
			(select tsd.staff_name from t_sys_store_staff_details tsd where tsd.party_id = tspr.proceeds_by) payee,
			tspr.create_date createDate,
			tspr.payment_method paymentMethod,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tspr.payment_method) paymentMethodName,
			tspr.payment_amount amount,
			(case when tspr.pay_status = '2801' and tspr.payment_method in ('2506','2507') then tfmr.zbiiln 
				else tspr.serial_number end)zbiiln,
			(case when tspr.pay_status = '2801' then tfmr.zdbankn else tspr.account_name end)zdbankn,
			(case when tspr.pay_status = '2801' then tfmr.zdname else tspr.payment_account end)zdname,
			(case when tspr.pay_status = '2801' and tspr.payment_method in ('2506','2507')
				then (select td.dict_value from t_sys_datadict td where td.dict_code=tfmr.received_method) 
				else (select td.dict_value from t_sys_datadict td where td.dict_code=tspr.payment_method) end)receiptMethod,
			(case when tspr.pay_status = '2801' and tspr.payment_method in ('2506','2507') then tfmr.received_date 
				else tspr.create_date end) receiptDate,
			(case when tspr.pay_status = '2801' and tspr.payment_method in ('2506','2507') then tfmr.approval_date 
				else tspr.create_date end) approvalDate,
			toi.order_price orderAmount,
			toi.receivable_price receivableAmount,
			toi.received_price receivedAmount,
			toi.car_vin vin,
			toi.delivery_person deliveryPerson,
			(select tsd.staff_name from t_sys_store_staff_details tsd where tsd.party_id = toi.delivery_person) deliveryPersonName,
			toi.customer_name customerName,
			toi.customer_phone customerPhone,
			toi.order_status orderStatus,
			(case when toi.order_status = '7409' then '已转交付待分配' 
				  when toi.order_status in ('7403','7408') then '已转交付待全款'
				  when toi.order_status in ('7404','7405') then '已全款待交付'
				  when toi.order_status = '7406' then '已交付' end) orderStatusName
		from
			t_psi_sales_payment_record tspr 
		left join t_psi_order_info toi on tspr.order_info_id = toi.order_info_id
		left join t_sys_store_info tsi on toi.delivery_store = tsi.store_id
		left join t_sys_flow_matching_record tfmr on tspr.matching_id = tfmr.record_id and tfmr.approval_operation != '03'
		where toi.is_enable = '01'
		and toi.is_delete = '00'
		and tspr.pay_status !='2800'
		) tt
		where 1=1
		<if test="deliveryPersonName !=null and deliveryPersonName !='' ">
			and tt.deliveryPersonName like concat('%',#{deliveryPersonName},'%')
		</if>
		<if test="orderNo !=null and orderNo !='' ">
			and tt.orderNum like concat('%',#{orderNo},'%')
		</if>
		<if test="customerName !=null and customerName !='' ">
			and tt.customerName like concat('%',#{customerName},'%')
		</if>
		<if test="deliveryStore !=null">
			and tt.deliveryStore = #{deliveryStore}
		</if>
		<if test="deliveryPerson !=null">
			and tt.deliveryPerson = #{deliveryPerson}
		</if>
		<if test="paymentStartDate !=null and paymentStartDate !='' ">
			and tt.createDate >= STR_TO_DATE(#{paymentStartDate}, '%Y-%m-%d %H:%i:%s')
		</if>
		<if test="paymentEndDate !=null and paymentEndDate !='' ">
			and tt.createDate &lt;= STR_TO_DATE(#{paymentEndDate}, '%Y-%m-%d %H:%i:%s')
		</if>
		<if test="payStatus !=null and payStatus !='' ">
			and tt.payStatus = #{payStatus}
		</if>
		<if test="recordCode !=null and recordCode !='' ">
			and tt.recordCode like concat('%',#{recordCode},'%')
		</if>
		<if test="approvalStartDate !=null and approvalStartDate !='' ">
			and tt.approvalDate >= STR_TO_DATE(#{approvalStartDate}, '%Y-%m-%d %H:%i:%s')
		</if>
		<if test="approvalEndDate !=null and approvalEndDate !='' ">
			and tt.approvalDate &lt;= STR_TO_DATE(#{approvalEndDate}, '%Y-%m-%d %H:%i:%s')
		</if>
		<if test="paymentType !=null and paymentType !='' ">
			and tt.paymentMethod = #{paymentType}
		</if>
		<if test="zbiiln !=null and zbiiln !='' ">
			and tt.zbiiln like concat('%',#{zbiiln},'%')
		</if>
		order by tt.createDate desc
	</select>
	
	<select id="queryPayDetails" resultType="com.exp.ucmp.pay.dto.PayDetailsDto">
	select
		toi.order_no orderNum,
		tspr.record_code recordCode,
		tspr.payment_item paymentItem,
		(select td.dict_value from t_sys_datadict td where td.dict_code=tspr.payment_item) paymentItemName,
		tspr.pay_status payStatus,
		(select td.dict_value from t_sys_datadict td where td.dict_code=tspr.pay_status)payStatusName,
		(select tsd.staff_name from t_sys_store_staff_details tsd where tsd.party_id = tspr.proceeds_by) payee,
		tspr.create_date createDate,
		tspr.payment_method paymentMethod,
		(select td.dict_value from t_sys_datadict td where td.dict_code=tspr.payment_method) paymentMethodName,
		tspr.payment_amount amount,
		tspr.payment_account paymentAccount, 
		toi.customer_name customerName,
		tspr.serial_number serialNumber,
		tspr.matching_id matchingId
	from
		t_psi_sales_payment_record tspr 
	left join t_psi_order_info toi on tspr.order_info_id = toi.order_info_id
	where tspr.record_code = #{recordCode}
	</select>
	
	<select id="queryStatementDetails" resultType="com.exp.ucmp.pay.dto.StatementDetailsDto">
	select
		tspr.record_code recordCode,
		(case when tspr.pay_status = '2801' and tspr.payment_method in ('2506','2507') then tfmr.zbiiln else tspr.serial_number end)zbiiln,
		(case when tspr.pay_status = '2801' then tfmr.zdbankn else tspr.account_name end)zdbankn,
		(case when tspr.pay_status = '2801' then tfmr.zdname else tspr.payment_account end)zdname,
		(case when tspr.pay_status = '2801' then (select td.dict_value from t_sys_datadict td where td.dict_code=tfmr.received_method) 
			  else (select td.dict_value from t_sys_datadict td where td.dict_code=tspr.payment_method) end)receiptMethod,
		(case when tspr.pay_status = '2801' then tfmr.received_amount else tspr.payment_amount end)zcrtrsamt,
		tfmr.received_date receiptDate,
		tfmr.bill_url fileUrl,
		tfmr.material_file_id materialId,
		(select tmf.thumbnail from t_sys_material_file tmf where tmf.material_file_id = tfmr.material_file_id) thumbnail
	from
		t_psi_sales_payment_record tspr 
		left join t_sys_flow_matching_record tfmr on tspr.matching_id = tfmr.record_id
	where tspr.record_code = #{recordCode}
	</select>
	
	<select id="queryBankStatementInfo" resultType="com.exp.ucmp.pay.dto.QueryBankStatementDto">
	select
		tbts.zdname,
		tbts.zdbankn,
		tbts.zpwbankn,
		tbts.ztrdate,
		concat( tbts.ztrdate, ' ', tbts.ztrtime ) receiptDate,
		tbts.zcrtrsamt,
		tbts.matching_amount matchingAmount,
		tbts.ztext,
		tbts.zbiiln,
		tbts.bukrs
	from
		t_sys_bank_transfer_statement tbts
	<trim prefix="WHERE" prefixOverrides="AND" >
		<if test="zdname !=null and zdname !='' ">
		and tbts.zdname like concat('%',#{zdname},'%')
		</if>
		<if test="ztrdate !=null and ztrdate !='' ">
		and tbts.ztrdate =#{ztrdate}
		</if>
		<if test="zcrtrsamt !=null and zcrtrsamt !='' ">
		and tbts.zcrtrsamt = #{zcrtrsamt}
		</if>
		<if test="ztext !=null and ztext !='' ">
		and tbts.ztext like concat('%',#{ztext},'%')
		</if>
		<if test="zbiiln !=null and zbiiln !='' ">
		and tbts.zbiiln like concat('%',#{zbiiln},'%')
		</if>
	</trim>
	order by
		tbts.ztrdate desc,
		tbts.ztrtime desc
	</select>
	
	<select id="rejectPayInfo" parameterType="com.exp.ucmp.pay.dto.PayRejectDto">
	update
		t_psi_sales_payment_record tspr
	set
		tspr.pay_status = '2807',
		tspr.update_by = #{partyId},
		tspr.update_date = now()
	where
		tspr.record_code = #{recordCode}
	</select>
	
	<update id="updatePayRecordInfo" parameterType="com.exp.ucmp.pay.dto.PayMatchingDto">
	update
		t_psi_sales_payment_record tspr
	set
		tspr.pay_status = #{payStatus},
		<if test="payStatus =='2801'">
		tspr.matching_id = #{recordId},
		</if>
		<if test="payStatus =='2806'">
		tspr.matching_id = null,
		</if>
		tspr.update_by = #{partyId},
		tspr.update_date = now()
	where
		tspr.record_code = #{recordCode}
	</update>
	
	<insert id="addMatchingRecord" parameterType="com.exp.ucmp.pay.dto.StatementDetailsDto">
	insert
		into
			t_sys_flow_matching_record ( record_id,
			record_code,
			zbiiln,
			zdbankn,
			zdname,
			received_method,
			received_amount,
			received_date,
			bill_url,
			material_file_id,
			approval_operation,
			approval_date,
			created_by,
			created_date,
			updated_by,
			updated_date )
		values( #{recordId},
		#{recordCode},
		#{zbiiln, jdbcType=VARCHAR},
		#{zdbankn, jdbcType=VARCHAR},
		#{zdname, jdbcType=VARCHAR},
		#{receiptMethod},
		#{zcrtrsamt},
		#{receiptDate},
		#{fileUrl, jdbcType=VARCHAR},
		#{materialId,jdbcType=BIGINT},
		#{approvalOperation},
		now(),
		#{partyId},
		now(),
		#{partyId},
		now() )
	</insert>
	
	<update id="updateBankStatementInfo">
	update
		t_sys_bank_transfer_statement tbts
	set
		tbts.matching_amount = #{matchingAmount},
		tbts.updated_by = #{partyId},
		tbts.updated_date = now()
	where
		tbts.zbiiln = #{zbiiln}
	</update>
	
	<update id="rollbackOrderInfo">
	update
		t_psi_order_info toi
	set
		<if test="paymentItem == '6702'">
		toi.set_payment_sum = toi.set_payment_sum - #{amount},
		toi.set_payment_time = #{payTime},
		</if>
		<if test="paymentItem == '6703'">
		toi.balance_payment_sum = toi.balance_payment_sum - #{amount},
		toi.balance_payment_time = #{payTime},
		</if>
		<if test="paymentItem == '6704'">
		toi.other_payments = toi.other_payments - #{amount},
		</if>
		<if test="payStatus != null">
		toi.order_status = #{payStatus},
		</if>
		toi.received_price = #{receivedPrice},
		toi.not_received_price = #{notReceivedPrice},
		toi.updated_by = #{partyId},
		toi.updated_date = now()
	where
		toi.order_info_id = #{orderInfoId}
	</update>
	
	<select id="getOrderNo" resultType="java.lang.String">
	select toi.order_no from t_psi_order_info toi where toi.order_info_id = #{orderId}
	</select>
</mapper>