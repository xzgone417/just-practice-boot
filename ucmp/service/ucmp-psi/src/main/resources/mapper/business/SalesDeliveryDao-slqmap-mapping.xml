<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.exp.ucmp.salesDelivery.dao.SalesDeliveryDao">

	<select id="delivryOrderList" resultType="com.exp.ucmp.salesDelivery.dto.DeliveryOrderDto" parameterType="com.exp.ucmp.salesDelivery.dto.DeliveryOrderParamDto">
	select
		toi.order_info_id orderInfoId,
		toi.order_no businessOrderNo,
		toi.car_vin vin,
		toi.customer_name customerName,
		toi.customer_phone enCustomerIphone,
		toi.order_status status,
		(case when toi.order_status = '7409' then '已转交付待分配' 
			  when toi.order_status in ('7403','7408') then '已转交付待全款'
			  when toi.order_status in ('7404','7405') then '已全款待交付'
			  when toi.order_status = '7406' then '已交付' end) statusName,
		(case when toi.delivery_person = #{partyId} and toi.order_status != '7406' then 1 else 2 end) isFollow
	from
		t_psi_order_info toi
	where
		toi.delivery_store = #{storeId}
		<if test="isAll == 1 ">
		and toi.delivery_person = #{partyId}
		</if>
		<if test="status == '7409' or status == '7406' ">
		and toi.order_status = #{status}
		</if>
		<if test="status == '7403' ">
		and toi.order_status in ('7403','7408')
		</if>
		<if test="status == '7404' ">
		and toi.order_status in ('7404','7405')
		</if>
		<if test="searchWord != null and searchWord != '' ">
		and (toi.customer_name like #{searchWord} or toi.order_no like #{searchWord} or toi.customer_phone = #{customerIphone})
		</if>
		order by toi.created_date desc
	</select>
	
	<select id="delivryConsultantList" resultType="com.exp.ucmp.storeApp.dto.OneselfAcquirerDto">
		select distinct
			tssi.party_id partyId,
			tssi.store_id storeId,
			tssi.user_name consultant,
			tssi.phone_number consultantTel,
			tssi.idm_account_name idmAccountName
		from
			t_sys_store_staff_info tssi
		where
			1=1
			<if test="storeId !=null">
			and tssi.store_id = #{storeId}
			</if>
			<if test="roleList !=null">
			and tssi.role_code in
			<foreach collection="roleList" index="index" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
			</if>
			<if test="searchWord !=null and searchWord !=''">
			and (tssi.user_name like concat('%',#{searchWord},'%') or tssi.phone_number = #{phoneNumber})
			</if>
	</select>
	
	<select id="countUndoneNum" resultType="int">
		select
			count( toi.order_info_id )
		from
			t_psi_order_info toi
		where
			toi.delivery_store = #{storeId}
			and toi.delivery_person = #{partyId}
			and toi.order_status in ( '7403', '7404', '7405', '7408', '7409' )
	</select>
	
	<select id="checkConsultant" resultType="int">
		select
			count( tssi.party_id )
		from
			t_sys_store_staff_info tssi
		where
			tssi.party_id = #{partyId}
			<if test="storeId != null">
			and tssi.store_id = #{storeId}
			</if>
			<if test="storeId == null">
			and tssi.store_id =	(select toi.delivery_store from t_psi_order_info toi where toi.order_info_id = #{orderInfoId})
			</if>
			
	</select>
	
	<select id="checkOrderStatus" resultType="int">
		select count(1) from t_psi_order_info toi where toi.order_info_id = #{orderInfoId} and toi.order_status = '7409'
	</select>
	
	<update id="updateOrderInfo">
	update
		t_psi_order_info toi
	set
		toi.delivery_person = #{partyId},
		<if test="status =='7409' ">
		toi.order_status = '7403',
		</if>
		<if test="isAll == 3">
		toi.delivery_store = #{storeId},
		</if>
		toi.updated_by = #{updateBy},
		toi.updated_date = now()
	where
		toi.order_info_id = #{orderInfoId}
	</update>
	
	<select id="orderDetails" resultType="com.exp.ucmp.salesDelivery.dto.DeliveryOrderDetailsDto">
		select distinct
			toi.order_info_id orderInfoId,
			toi.customer_name customerName,
			toi.customer_phone enCustomerIphone,
			toi.order_no businessOrderNo,
			toi.car_vin vin,
			toi.base_car_type_name baseCarTypeName,
			toi.interior_color interiorColor,
			toi.exterior_color exteriorColor,
			toi.order_price orderPrice,
			toi.created_date createdDate,
			toi.order_status status,
			(case when toi.order_status = '7409' then '已转交付待分配' 
			  when toi.order_status in ('7403','7408') then '已转交付待全款'
			  when toi.order_status in ('7404','7405') then '已全款待交付'
			  when toi.order_status = '7406' then '已交付' end) statusName,
			toi.intention_pay_time intentionPayTime,
			(case when toi.car_owner_type = '01' then '个人' else '公司' end) carOwnerType,
			toi.licensing_city licensingCity,
			toi.sales_store salesStoreId,
			tsi.org_name salesStoreName,
			toi.created_by salesConsultantId,
			tssi.user_name salesConsultantName,
			td.dict_value type,
			toi.owner_card_no ownerCardNo,
			toi.order_remark orderRemark,
			(case when toi.delivery_person = #{partyId} then 1 else 2 end) isFollow
		from
			t_psi_order_info toi
			left join t_sys_store_info tsi on toi.sales_store = tsi.store_id
			left join t_sys_store_staff_info tssi on toi.created_by = tssi.party_id
			left join t_sys_datadict td on toi.type_id = td.dict_code
		where
			toi.is_delete = '00'
			and toi.order_info_id = #{orderInfoId}
			<if test="isAll != 3">
			and toi.delivery_store = #{storeId}
			</if>
			<if test="isAll == null ">
			and toi.delivery_person = #{partyId}
			</if>
	</select>
	
	<delete id="clearMaterial">
		delete
	from
		t_psi_sales_order_material tsm
	where
		tsm.order_info_id = #{orderInfoId}
		and tsm.material_type in
		<foreach collection="materialType" index="index" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
	</delete>
	
	<select id="checkStoreOrder" resultType="int">
		select count(order_info_id) from t_psi_order_info toi where toi.order_info_id = #{orderInfoId} and toi.delivery_store = #{storeId}
	</select>
	
	<select id="materialList" resultType="com.exp.ucmp.salesDelivery.dto.DeliveryOrderPicDto">
	select
		tsm.material_id materialId,
		tmf.material_order materialOrder,
		tmf.thumbnail,
		tsm.material_type materialType,
		td.dict_value materialTypeName,
		tfm.file_path fileUrl
	from
		t_psi_sales_order_material tsm,
		t_sys_material_file tmf,
		t_sys_file_msg tfm,
		t_sys_datadict td
	where
		tsm.material_id = tmf.material_file_id
		and tmf.file_id = tfm.file_id
		and td.dict_code = tsm.material_type
		and tsm.order_info_id = #{orderInfoId}
		<if test="materialType != null and materialType.size() >0">
		and tsm.material_type in 
		<foreach collection="materialType" index="index" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
	order by tsm.material_type asc,tmf.material_order asc
	</select>
	
	<select id="checkOrderTransferInfo" resultType="Long">
	select
		tcra.transfer_apply_id
	from
		t_psi_car_transfer_apply tcra
	where
		tcra.order_info_id = #{orderInfoId}
		and tcra.is_delete='00'
		and tcra.is_enable='01'
		and ( tcra.transfer_status not in ( '5207', '5208', '5209' ) or tcra.is_submit != '02' )
	</select>
	
	<resultMap type="java.util.Map" id="orderCarInfo">
		<result column="storageId" property="storageId" javaType="java.lang.String" />
		<result column="receivedPrice" property="receivedPrice" javaType="java.lang.String" />
		<result column="stockId" property="stockId" javaType="java.lang.String" />
	</resultMap>
	
	<select id="getOrderCarInfo" resultMap="orderCarInfo">
	select
		tsi.storage_id storageId,
		received_price receivedPrice,
		toi.stock_id stockId
	from
		t_psi_order_info toi,
		t_psi_car_stock_info tsi
	where
		toi.stock_id = tsi.stock_id
		and toi.order_info_id = #{orderInfoId}
	</select>
	
	<select id="transferApplyInfo" resultType="com.exp.ucmp.salesDelivery.dto.OrderCarTransferInfoDto">
	select
		toi.order_info_id orderInfoId,
		tcra.transfer_apply_id transferApplyId,
		tcra.transfer_storage_id goalStorageId,
		tcus.storage_name goalStorageName,
		DATE_FORMAT(tcra.start_time, '%Y-%m-%d') startTime,
		DATE_FORMAT(tcra.expected_time, '%Y-%m-%d') expectedTime,
		tcra.transfer_type transferType,
		(select td.dict_value from t_sys_datadict td where  td.dict_code =tcra.transfer_type) transferTypeName,
		tcra.marks,
		tcra.is_submit isSubmit,
		tcra.transfer_status transferStatus,
		(select td.dict_value from t_sys_datadict td where td.dict_code = tcra.transfer_status) transferStatusName
	from
		t_psi_car_transfer_apply tcra,
		t_psi_order_info toi,
		t_sys_car_used_storage tcus
	where
		tcra.order_info_id = toi.order_info_id
		and tcra.transfer_storage_id = tcus.storage_id
		and tcra.is_submit != '02'
		and tcra.order_info_id = #{orderInfoId}
		and toi.delivery_store = #{storeId}
		<if test="isAll == null">
		and toi.delivery_person = #{partyId}
		</if>
	</select>
	
	<update id="updateTransferApplyInfo">
	update
		t_psi_car_transfer_apply tcra
	set
		tcra.is_submit = '02',
		tcra.updated_by = #{updateBy},
		tcra.updated_date = now()
	where
		tcra.transfer_apply_id = #{transferApplyId}
	</update>
	
	<select id="paymentInfo" resultType="com.exp.ucmp.salesDelivery.dto.OrderPaymentInfoDto">
	select
		toi.order_info_id orderInfoId,
		toi.order_no orderNo,
		toi.receivable_price receivablePrice,
		toi.received_price receivedPrice,
		toi.not_received_price notReceivedPrice,
		td.dict_value revertBodyName,
		td.dict_code revertBody,
		toi.financial_loan financialAmount,
		toi.set_payment_sum setPaymentSum,
		toi.balance_payment_sum balancePaymentSum,
		toi.other_payments otherPayments
	from
		t_psi_order_info toi,
		t_psi_car_stock_info tsi,
		t_sys_datadict td
	where
		toi.stock_id = tsi.stock_id
		and tsi.revert_body = td.dict_code
		and toi .order_info_id = #{orderInfoId}
		<if test="isAll !=2 ">
		and toi.delivery_store = #{storeId}
		</if>
		<if test="isAll ==2">
		and toi.sales_store = #{storeId}
		</if>
		<if test="isAll == null ">
		and toi.delivery_person = #{partyId}
		</if>
	</select>
	
	<select id="paymentRecord" resultType="com.exp.ucmp.salesDelivery.dto.OrderPaymentRecordDto">
	select
		distinct tpr.record_id recordId,
		tpr.record_code recordCode,
		tpr.order_info_id orderInfoId,
		tpr.create_date createDate,
		(select td.dict_value from t_sys_datadict td where td.dict_code = tpr.payment_item) paymentItem,
		tpr.payment_amount paymentAmount,
		tpr.serial_number serialNumber,
		tssi.user_name proceedsBy,
		tpr.payment_method paymentMethod,
		(select td.dict_value from t_sys_datadict td where td.dict_code = tpr.payment_method) paymentMethodName,
		tpr.payment_account paymentAccount,
		tpr.account_name accountName,
		tpr.pay_status payStatus,
		(select td.dict_value from t_sys_datadict td where td.dict_code=tpr.pay_status)payStatusName
	from
		t_psi_sales_payment_record tpr,
		t_sys_store_staff_info tssi
	where tpr.proceeds_by= tssi.party_id
	  and tpr.pay_status !='2800'
	  and tpr.order_info_id = #{orderInfoId}
	order by tpr.create_date desc
	</select>
	
	<update id="updateFinancialLoan">
	update
		t_psi_order_info toi
	set
		<if test="orderStatus !=null">
		toi.order_status = #{orderStatus},
		</if>
		toi.financial_loan = #{amount, jdbcType=DECIMAL},
		<if test="setPaymentSum != null">
		toi.set_payment_sum = #{setPaymentSum, jdbcType=DECIMAL},
		</if>
		<if test="balancePaymentSum != null">
		toi.balance_payment_sum = #{balancePaymentSum, jdbcType=DECIMAL},
		</if>
		<if test="otherPayments != null">
		toi.other_payments = #{otherPayments, jdbcType=DECIMAL},
		</if>
		toi.not_received_price = #{notReceivedPrice},
		toi.received_price = #{receivedPrice},
		toi.updated_by = #{updateBy},
		toi.updated_date = now()
	where
		toi .order_info_id = #{orderInfoId}
	</update>
	
	<select id="checkOrderConsultant" resultType="int">
		select
			count(toi.order_info_id)
		from
			t_psi_order_info toi
		where
			toi.order_info_id = #{orderInfoId}
		and toi.delivery_person = #{updateBy}
		and toi.delivery_store = #{storeId}
	</select>
	
	<select id="pdiInfo" resultType="com.exp.ucmp.salesDelivery.dto.OrderPdiInfoDto">
	select
		toi.pdi_status pdiStatus,
		(select td.dict_value from t_sys_datadict td where td.dict_code = toi.pdi_status) pdiStatusName,
		toi.pdi_result pdiResult,
		(select td.dict_value from t_sys_datadict td where td.dict_code = toi.pdi_result) pdiResultName
	from
		t_psi_order_info toi
	where
		toi.order_info_id = #{orderInfoId}
		and toi.delivery_store = #{storeId}
		<if test="isAll != null ">
		and toi.delivery_person = #{partyId}
		</if>
	</select>
	
	<update id="updateOrderPdiInfo">
	update
		t_psi_order_info toi
	set
		<if test="pdiStatus !=null and pdiStatus !=''">
		toi.pdi_status = #{pdiStatus,jdbcType=VARCHAR},
		</if>
		toi.pdi_result = #{pdiResult},
		toi.updated_by = #{partyId},
		toi.updated_date = now()
	where
		toi.order_info_id = #{orderInfoId}
	</update>
	
	<select id="deliveryProfile" resultType="com.exp.ucmp.salesDelivery.dto.OrderDeliveryProfileDto">
	select
		toi.main_user_name mainUserName,
		toi.main_user_phone mainUserPhone,
		toi.main_card_no mainCardNo
	from
		t_psi_order_info toi
	where
		toi .order_info_id = #{orderInfoId}
		and toi.delivery_store = #{storeId}
		<if test="isAll != null ">
		and toi.delivery_person = #{partyId}
		</if>
	</select>
	
	<update id="updateMainUserInfo" parameterType="com.exp.ucmp.salesDelivery.dto.OrderDeliveryProfileDto">
	update
		t_psi_order_info toi
	set
		toi.main_user_name = #{mainUserName},
		toi.main_user_phone = #{mainUserPhone},
		toi.main_card_no = #{mainCardNo,jdbcType=VARCHAR},
		toi.updated_by = #{updateBy},
		toi.updated_date = now()
	where
		toi .order_info_id = #{orderInfoId}
	</update>
	
	<update id="updateOderStatus" parameterType="com.exp.ucmp.salesDelivery.dto.OrderDeliveryProfileDto">
	update
		t_psi_order_info toi
	set
		toi.order_status = '7406',
		toi.updated_by = #{updateBy},
		toi.updated_date = now()
	where
		toi .order_info_id = #{orderInfoId}
	</update>
	
	<select id="queryPartyId" resultType="java.lang.Long">
    	select
			tum.party_id
		from
			t_sys_store_staff_user_mapping tum
		where
			tum.user_id = #{userId}
		union select
			tsi.party_id
		from
			t_sys_store_staff_info tsi
		where
			tsi.user_id = #{userId}
    </select>
    
    <select id="queryStoreId" resultType="java.lang.Long">
    	select tsi.store_id from t_sys_store_info tsi where tsi.org_id = #{departmentId}
    </select>
    
    <select id="countUnAllocatedNum" resultType="java.lang.Integer">
    	select
			count( toi.order_info_id )
		from
			t_psi_order_info toi
		where toi.order_status = '7409'
		and toi.delivery_store =#{storeId}
    </select>
    
    <select id="countUnFullPaymentNum" resultType="java.lang.Integer">
    	select
			count( toi.order_info_id )
		from
			t_psi_order_info toi
		where toi.order_status = '7403'
		and toi.delivery_store = #{storeId}
		<if test="partyId !=null">
		and toi.delivery_person = #{partyId}
		</if>
    </select>
    
    <select id="countUnDeliveryNum" resultType="java.lang.Integer">
    	select
			count( toi.order_info_id )
		from
			t_psi_order_info toi
		where toi.order_status in ('7404','7405')
		and toi.delivery_store = #{storeId}
		<if test="partyId !=null">
		and toi.delivery_person = #{partyId}
		</if>
    </select>
    
    <select id="countDeliveredNum" resultType="java.lang.Integer">
    	select
			count( toi.order_info_id )
		from
			t_psi_order_info toi
		where toi.order_status = '7406'
		and toi.delivery_store = #{storeId}
		<if test="partyId !=null">
		and toi.delivery_person = #{partyId}
		</if>
    </select>
    
    <select id="queryAlias" resultType="String">
    select
		distinct tssi.idm_account_name
	from
		t_sys_store_staff_info tssi
	where
		tssi.party_id = #{partyId}
    </select>
    
   <select id="queryOrderNum" resultType="String">
	   select
			toi.order_no
		from
			t_psi_order_info toi
		where
			toi.order_info_id = #{orderInfoId}
   </select>
   
   <update id="updateStockCarStatus">
   update
		t_psi_car_stock_info tcsi
	set
		tcsi.stock_state = '5106',
		tcsi.updated_by = #{partyId},
		tcsi.updated_date = now()
	where
		tcsi.stock_id = ( select toi.stock_id from t_psi_order_info toi where toi.order_info_id = #{orderInfoId})
   </update>
</mapper>
