<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.exp.ucmp.inventory.dao.PsiCarStockInfoDao">

    <resultMap id="psiCarStockInfoResultMap" type="com.exp.ucmp.stock.dto.CarStockInfoDto" >
        <result column="stock_id" property="stockId" jdbcType="BIGINT" />
        <result column="product_code" property="productCode" jdbcType="VARCHAR" />
        <result column="storage_id" property="storageId" jdbcType="BIGINT" />
        <result column="storage_name" property="storageName" jdbcType="VARCHAR" />
        <result column="storage_code" property="storageCode" jdbcType="VARCHAR" />
        <result column="car_source" property="carSource" jdbcType="VARCHAR" />
        <result column="car_source_name" property="carSourceName" jdbcType="VARCHAR" />
        <result column="car_type" property="carType" jdbcType="VARCHAR" />
        <result column="car_type_name" property="carTypeName" jdbcType="VARCHAR" />
        <result column="stock_type" property="stockType" jdbcType="VARCHAR" />
        <result column="stock_type_name" property="stockTypeName" jdbcType="VARCHAR" />
        <result column="source_batch" property="sourceBatch" jdbcType="VARCHAR" />
        <result column="revert_body" property="revertBody" jdbcType="VARCHAR" />
        <result column="revert_body_name" property="revertBodyName" jdbcType="VARCHAR" />
        <result column="vin_code" property="vinCode" jdbcType="VARCHAR" />
        <result column="purchase_price" property="purchasePrice" jdbcType="DECIMAL" />
        <result column="sale_price" property="salePrice" jdbcType="DECIMAL" />
        <result column="decision_type" property="decisionType" jdbcType="VARCHAR" />
        <result column="decision_type_name" property="decisionTypeName" jdbcType="VARCHAR" />
        <result column="warehous_date" property="warehousDate" jdbcType="TIMESTAMP" />
        <result column="refund_sign" property="refundSign" jdbcType="VARCHAR" />
        <result column="refund_warehous_date" property="refundWarehousDate" jdbcType="TIMESTAMP" />
        <result column="deliver_date" property="deliverDate" jdbcType="TIMESTAMP" />
        <result column="car_series_name" property="carSeriesName" jdbcType="VARCHAR" />
        <result column="base_car_type_name" property="baseCarTypeName" jdbcType="VARCHAR" />
        <result column="car_colour" property="carColour" jdbcType="VARCHAR" />
        <result column="car_nature" property="carNature" jdbcType="VARCHAR" />
        <result column="car_nature_name" property="carNatureName" jdbcType="VARCHAR" />
        <result column="license_place" property="licensePlace" jdbcType="VARCHAR" />
        <result column="license_number" property="licenseNumber" jdbcType="VARCHAR" />
        <result column="first_license_date" property="firstLicenseDate" jdbcType="TIMESTAMP" />
        <result column="accident_insurance_end_date" property="accidentInsuranceEndDate" jdbcType="TIMESTAMP" />
        <result column="yearly_inspection_end_date" property="yearlyInspectionEndDate" jdbcType="TIMESTAMP" />
        <result column="invoicing_date" property="invoicingDate" jdbcType="TIMESTAMP" />
        <result column="transfer_count" property="transferCount" jdbcType="TINYINT" />
        <result column="stock_state" property="stockState" jdbcType="VARCHAR" />
        <result column="stock_state_name" property="stockStateName" jdbcType="VARCHAR" />
        <result column="repeal_is" property="repealIs" jdbcType="VARCHAR" />
        <result column="repeal_reason" property="repealReason" jdbcType="VARCHAR" />
        <result column="repeal_date" property="repealDate" jdbcType="TIMESTAMP" />
        <result column="car_level" property="carLevel" jdbcType="VARCHAR" />
        <result column="manufacture_date" property="manufactureDate" jdbcType="VARCHAR" />
    </resultMap>

    <sql id="t_psi_car_stock_info_Column_List" >
        a.stock_id,
        a.product_code,
        a.storage_id,
        a.storage_name,
        a.storage_code,
        a.car_source,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.car_source)car_source_name,
        a.car_type,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.car_type)car_type_name,
        a.stock_type,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.stock_type)stock_type_name,
        a.source_batch,
        a.revert_body,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.revert_body)revert_body_name,
        a.vin_code,
        a.purchase_price,
        a.sale_price,
        a.decision_type,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.decision_type)decision_type_name,
        a.warehous_date,
        a.refund_sign,
        a.refund_warehous_date,
        a.deliver_date,
        a.car_series_name,
        a.base_car_type_name,
        a.car_colour,
        a.car_nature,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.car_nature)car_nature_name,
        a.license_place,
        a.license_number,
        a.first_license_date,
        a.accident_insurance_end_date,
        a.yearly_inspection_end_date,
        a.invoicing_date,
        a.transfer_count,
        a.stock_state,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.stock_state)stock_state_name,
        a.repeal_is,
        a.repeal_date,
        a.repeal_reason,
        a.car_level,
        a.manufacture_date
    </sql>

    <select id="selectCarStockList" parameterType="com.exp.ucmp.stock.dto.CarStockInfoListQueryDto"
            resultMap="psiCarStockInfoResultMap">
        SELECT
        <include refid="t_psi_car_stock_info_Column_List"/>
        FROM
        t_psi_car_stock_info a
        left join t_sys_car_used_storage c on c.storage_id = a.storage_id
        <where>
            a.is_delete = '00'
			and a.is_enable = '01'
            <if test="storeIds != null and storeIds.size > 0">
                and c.org_id in
                (<foreach collection="storeIds" item="sta" separator=",">
                #{sta}
            </foreach>)
            </if>
            <if test="tabStockState != null and tabStockState.length > 0">
                AND a.stock_state IN
                <foreach item="item" collection="tabStockState" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
            <if test="carSeriesName != null and carSeriesName != ''">
                AND a.car_series_name = #{carSeriesName}
            </if>
            <if test="baseCarTypeName != null and baseCarTypeName != ''">
                AND a.base_car_type_name = #{baseCarTypeName}
            </if>
            <if test="stockState != null and stockState != ''">
                AND a.stock_state = #{stockState}
            </if>
            <if test="storageCode != null and storageCode != ''">
                AND a.storage_code = #{storageCode}
            </if>
            <if test="sourceBatch != null and sourceBatch != ''">
                AND a.source_batch = #{sourceBatch}
            </if>
            <if test="stockType != null and stockType != ''">
                AND a.stock_type = #{stockType}
            </if>
            <if test="vagueVinCode != null and vagueVinCode != ''">
                AND a.vin_code like CONCAT('%',#{vagueVinCode})
            </if>
            <if test="vinCode != null and vinCode != ''">
                AND a.vin_code like CONCAT('%',#{vinCode},'%')
            </if>
            <if test="productCode != null and productCode != ''">
                AND a.product_code like CONCAT('%',#{productCode},'%')
            </if>
            <if test="vinCodeList != null and vinCodeList.size > 0">
                AND a.vin_code in (
                <foreach collection="vinCodeList" item="vinCode" separator=",">
                    #{vinCode}
                </foreach>
                )
            </if>
            <if test="revertBody != null and revertBody.size > 0">
                and a.revert_body IN
                (<foreach collection="revertBody" item="sta" separator=",">
                    #{sta}
                </foreach>)
            </if>
            <if test="warehousStartDate != null and warehousStartDate != ''">
                AND a.warehous_date &gt;= #{warehousStartDate}
            </if>
            <if test="warehousEndDate != null and warehousEndDate != ''">
                AND a.warehous_date &lt; DATE_ADD(#{warehousEndDate},INTERVAL 1 DAY)
            </if>
            <if test="repealStartDate != null  and repealStartDate != ''">
                AND a.repeal_date &gt;= #{repealStartDate}
            </if>
            <if test="repealEndDate != null and repealEndDate != ''">
                AND a.repeal_date &lt; DATE_ADD(#{repealEndDate},INTERVAL 1 DAY)
            </if>
            <if test="decisionType != null and decisionType != '2303' and decisionType != ''">
                AND a.decision_type = #{decisionType}
            </if>
            <if test="decisionType =='2303'">
            	and a.sale_price is not null
				and a.product_code is not null
                AND a.decision_type != '2302'
            </if>
            <if test="repealIs != null and repealIs != ''">
                AND a.repeal_is = #{repealIs}
            </if>
        </where>
        ORDER BY
        a.created_date DESC
    </select>

    <select id="selectCarStockOutList" parameterType="com.exp.ucmp.stock.dto.CarStockInfoListQueryDto"
            resultType="com.exp.ucmp.stock.dto.CarStockInfoDto">
        SELECT
        b.stock_id stockId,
        a.product_code productCode,
        b.stock_type stockType,
        (select td.dict_value from t_sys_datadict td where td.dict_code=b.stock_type) stockTypeName,
        b.storage_name storageName,
        (select dict_value from t_sys_datadict  where dict_code = b.stock_type) stockType,
        b.stock_date outTime,
        a.storage_code storageCode,
        a.car_source carSource,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.car_source) carSourceName,
        a.car_type carType,
        (select td.dict_value from t_sys_datadict td where td.dict_code=a.car_type) carTypeName,
        a.source_batch sourceBatch,
        a.revert_body revertBody,
        (select dict_value from t_sys_datadict  where dict_code = a.revert_body) revertBodyName,
        a.vin_code vinCode,
        a.purchase_price purchasePrice,
        a.sale_price salePrice,
        (select dict_value from t_sys_datadict  where dict_code = a.decision_type) decisionType,
        a.warehous_date warehousDate,
        a.refund_sign refundSign,
        a.refund_warehous_date refundWarehousDate,
        a.deliver_date deliverDate,
        a.car_series_name carSeriesName,
        a.base_car_type_name baseCarTypeName,
        a.car_colour carColour,
        a.car_nature carNature,
        a.license_place licensePlace,
        a.license_number licenseNumber,
        a.first_license_date firstLicenseDate,
        a.accident_insurance_end_date accidentInsuranceEndDate,
        a.yearly_inspection_end_date yearlyInspectionEndDate,
        a.invoicing_date invoicingDate,
        a.transfer_count transferCount,
        (select dict_value from t_sys_datadict  where dict_code = a.stock_state) stockState,
        a.repeal_is repealIs
        FROM
        t_psi_car_stock_history b
        JOIN t_psi_car_stock_info a
        On
        a.stock_id = b.stock_id
        left join t_sys_car_used_storage c on c.storage_id = a.storage_id
        where a.is_delete = '00' and a.is_enable = '01'
        <if test="storeIds.size > 0">
            and c.org_id in
            (<foreach collection="storeIds" item="sta" separator=",">
            #{sta}
        </foreach>)
        </if>
        and b.stock_type in ('5403','5404')
        <if test="carSeriesName != null and carSeriesName != ''">
            AND a.car_series_name = #{carSeriesName}
        </if>
        <if test="baseCarTypeName != null and baseCarTypeName != ''">
            AND a.base_car_type_name = #{baseCarTypeName}
        </if>
        <if test="stockState != null and stockState != ''">
            AND a.stock_state = #{stockState}
        </if>
        <if test="storageCode != null and storageCode != ''">
            AND a.storage_code = #{storageCode}
        </if>
        <if test="sourceBatch != null and sourceBatch != ''">
            AND a.source_batch = #{sourceBatch}
        </if>
        <if test="stockType != null and stockType != ''">
            AND b.stock_type = #{stockType}
        </if>
        <if test="vinCode != null and vinCode != ''">
            AND a.vin_code = #{vinCode}
        </if>
        <if test="revertBody.size > 0">
            and a.revert_body IN
            (<foreach collection="revertBody" item="sta" separator=",">
            #{sta}
        </foreach>)
        </if>
        <if test="warehousStartDate != null and warehousStartDate!=''">
            AND a.warehous_date &gt;= #{warehousStartDate}
        </if>
        <if test="warehousEndDate != null and warehousEndDate!=''">
            AND a.warehous_date &lt; DATE_ADD(#{warehousEndDate},INTERVAL 1 DAY)
        </if>
        <if test="decisionType != null and decisionType != ''">
            AND a.decision_type = #{decisionType}
        </if>
        ORDER BY
        outTime DESC
    </select>

    <select id="findCarInfoByVinCode" parameterType="java.lang.String"
            resultType="com.exp.ucmp.transfer.dto.TransferApplyCarInfoDto">
        SELECT
            si.stock_id AS stockId,
            si.vin_code AS vinCode,
            si.warehous_date AS warehousDate,
            si.stock_type AS stockType,
            datediff(now(),si.warehous_date) AS stockAge,
            us.manager_name AS managerName,
            si.storage_id AS storageId,
            us.storage_address AS storageAddress,
            us.storage_name as storageName,
            us.manager_phone AS managerPhone,
            ca.transfer_status AS transferStatus
        FROM
            t_psi_car_stock_info si
            LEFT JOIN t_sys_car_used_storage us ON si.storage_id = us.storage_id
            LEFT JOIN t_psi_car_transfer_apply ca on si.stock_id = ca.stock_id
        WHERE
            si.stock_state != '5106'
        AND
            si.vin_code =  #{vinCode}
    </select>

    <select id="selectNewBySelective" parameterType="com.exp.ucmp.entity.PsiCarStockInfoEntity" resultMap="psiCarStockInfoResultMap">
        SELECT
        <include refid="t_psi_car_stock_info_Column_List" />
        FROM t_psi_car_stock_info a
        <trim prefix="WHERE" prefixOverrides="AND" >
            AND a.stock_state != 5106
            <if test="stockId != null" >
                AND a.stock_id = #{stockId, jdbcType=BIGINT}
            </if>
            <if test="storageId != null" >
                AND a.storage_id = #{storageId, jdbcType=BIGINT}
            </if>
            <if test="storageName != null and storageName != ''" >
                AND a.storage_name = #{storageName, jdbcType=VARCHAR}
            </if>
            <if test="storageCode != null and storageCode != ''" >
                AND a.storage_code = #{storageCode, jdbcType=VARCHAR}
            </if>
            <if test="carSource != null and carSource != ''" >
                AND a.car_source = #{carSource, jdbcType=VARCHAR}
            </if>
            <if test="carType != null and carType != ''" >
                AND a.car_type = #{carType, jdbcType=VARCHAR}
            </if>
            <if test="stockType != null and stockType != ''" >
                AND a.stock_type = #{stockType, jdbcType=VARCHAR}
            </if>
            <if test="sourceBatch != null and sourceBatch != ''" >
                AND a.source_batch = #{sourceBatch, jdbcType=VARCHAR}
            </if>
            <if test="revertBody != null and revertBody != ''" >
                AND a.revert_body = #{revertBody, jdbcType=VARCHAR}
            </if>
            <if test="vinCode != null and vinCode != ''" >
                AND a.vin_code = #{vinCode, jdbcType=VARCHAR}
            </if>
            <if test="purchasePrice != null" >
                AND a.purchase_price = #{purchasePrice, jdbcType=DECIMAL}
            </if>
            <if test="salePrice != null" >
                AND a.sale_price = #{salePrice, jdbcType=DECIMAL}
            </if>
            <if test="decisionType != null and decisionType != ''" >
                AND a.decision_type = #{decisionType, jdbcType=VARCHAR}
            </if>
            <if test="decisionTime != null" >
                AND a.decision_time = #{decisionTime, jdbcType=TIMESTAMP}
            </if>
            <if test="groundingTime != null" >
                AND a.grounding_time = #{groundingTime, jdbcType=TIMESTAMP}
            </if>
            <if test="warehousDate != null" >
                AND a.warehous_date = #{warehousDate, jdbcType=TIMESTAMP}
            </if>
            <if test="refundSign != null and refundSign != ''" >
                AND a.refund_sign = #{refundSign, jdbcType=VARCHAR}
            </if>
            <if test="refundWarehousDate != null" >
                AND a.refund_warehous_date = #{refundWarehousDate, jdbcType=TIMESTAMP}
            </if>
            <if test="deliverDate != null" >
                AND a.deliver_date = #{deliverDate, jdbcType=TIMESTAMP}
            </if>
            <if test="carSeriesName != null and carSeriesName != ''" >
                AND a.car_series_name = #{carSeriesName, jdbcType=VARCHAR}
            </if>
            <if test="baseCarTypeName != null and baseCarTypeName != ''" >
                AND a.base_car_type_name = #{baseCarTypeName, jdbcType=VARCHAR}
            </if>
            <if test="interiorColor != null and interiorColor != ''" >
                AND a.interior_color = #{interiorColor, jdbcType=VARCHAR}
            </if>
            <if test="carColour != null and carColour != ''" >
                AND a.car_colour = #{carColour, jdbcType=VARCHAR}
            </if>
            <if test="carNature != null and carNature != ''" >
                AND a.car_nature = #{carNature, jdbcType=VARCHAR}
            </if>
            <if test="licensePlace != null and licensePlace != ''" >
                AND a.license_place = #{licensePlace, jdbcType=VARCHAR}
            </if>
            <if test="licenseNumber != null and licenseNumber != ''" >
                AND a.license_number = #{licenseNumber, jdbcType=VARCHAR}
            </if>
            <if test="firstLicenseDate != null" >
                AND a.first_license_date = #{firstLicenseDate, jdbcType=TIMESTAMP}
            </if>
            <if test="accidentInsuranceEndDate != null" >
                AND a.accident_insurance_end_date = #{accidentInsuranceEndDate, jdbcType=TIMESTAMP}
            </if>
            <if test="yearlyInspectionEndDate != null" >
                AND a.yearly_inspection_end_date = #{yearlyInspectionEndDate, jdbcType=TIMESTAMP}
            </if>
            <if test="invoicingDate != null" >
                AND a.invoicing_date = #{invoicingDate, jdbcType=TIMESTAMP}
            </if>
            <if test="transferCount != null" >
                AND a.transfer_count = #{transferCount, jdbcType=TINYINT}
            </if>
            <if test="stockState != null and stockState != ''" >
                AND a.stock_state = #{stockState, jdbcType=VARCHAR}
            </if>
            <if test="repealIs != null and repealIs != ''" >
                AND a.repeal_is = #{repealIs, jdbcType=VARCHAR}
            </if>
            <if test="repealDate != null" >
                AND a.repeal_date = #{repealDate, jdbcType=TIMESTAMP}
            </if>
            <if test="repealReason != null and repealReason != ''" >
                AND a.repeal_reason = #{repealReason, jdbcType=VARCHAR}
            </if>
            <if test="rightPackId != null" >
                AND a.right_pack_id = #{rightPackId, jdbcType=BIGINT}
            </if>
            <if test="createdBy != null" >
                AND a.created_by = #{createdBy, jdbcType=BIGINT}
            </if>
            <if test="createdDate != null" >
                AND a.created_date = #{createdDate, jdbcType=TIMESTAMP}
            </if>
            <if test="updatedBy != null" >
                AND a.updated_by = #{updatedBy, jdbcType=BIGINT}
            </if>
            <if test="updatedDate != null" >
                AND a.updated_date = #{updatedDate, jdbcType=TIMESTAMP}
            </if>
            <if test="isEnable != null and isEnable != ''" >
                AND a.is_enable = #{isEnable, jdbcType=VARCHAR}
            </if>
            <if test="isDelete != null and isDelete != ''" >
                AND a.is_delete = #{isDelete, jdbcType=VARCHAR}
            </if>
        </trim>
    </select>

	<select id="findProductCodeList" resultType="java.lang.String">
	select
		tcsi.product_code
	from
		t_psi_car_stock_info tcsi
	where
		tcsi.stock_state not in ( '5105','5106' )
	and tcsi.sale_price is not null
	and tcsi.product_code is not null
	and tcsi.decision_type != '2302'
	and tcsi.repeal_is = '00'
	and tcsi.is_delete = '00'
	and tcsi.is_enable = '01'
	</select>
	
	<update id="updateSalePrice" parameterType="com.exp.ucmp.car.dto.CarSalePriceDto">
	update
		t_psi_car_stock_info tcsi
	set
		tcsi.sale_price = #{salePrice},
		<if test="oaCode == null or oaCode== ''">
		tcsi.change_price_record_id = null,
		</if>
		tcsi.updated_by = #{partyId},
		tcsi.updated_date = now()
	where
		tcsi.stock_id = #{stockId}
	</update>
	
	<insert id="addChangePriceRecord" parameterType="com.exp.ucmp.car.dto.ChangePriceParamDto">
	insert
		into
			t_psi_car_change_price_record ( record_id,
			stock_id,
			order_record_id,
			suggested_price,
			cur_price,
			change_price,
			change_reason,
			oa_code,
			approve_status,
			created_by,
			created_date,
			updated_by,
			updated_date )
		values( #{recordId},
		#{stockId},
		#{orderRecordId, jdbcType=BIGINT},
		#{suggestedPrice},
		#{curPrice},
		#{changePrice},
		#{changeReason},
		#{oaCode},
		0,
		#{createdBy},
		current_timestamp,
		#{updatedBy},
		current_timestamp )
	</insert>
	
	<update id="updateCarStockInfo" parameterType="com.exp.ucmp.car.dto.ChangePriceParamDto">
		update
			t_psi_car_stock_info tsi
		set
			tsi.change_price_record_id = #{recordId},
			tsi.suggested_price = #{suggestedPrice},
			tsi.updated_by = #{updatedBy},
			tsi.updated_date = now()
		where
			tsi.stock_id = #{stockId}
	</update>
	
	<select id="queryChangePriceApproveList" parameterType="com.exp.ucmp.car.dto.QueryChangePriceParamDto" 
		resultType="com.exp.ucmp.car.dto.QueryChangePriceDto">
		select
			tsi.stock_id stockId,
			tccpr.record_id recordId,
			tsi.car_type carType,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tsi.car_type) carTypeName,
			tsi.revert_body revertBody,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tsi.revert_body) revertBodyName,
			tsi.vin_code vin,
			tsi.product_code productCode,
			tsi.purchase_price purchasePrice,
			tsi.suggested_price suggestedPrice,
			tccpr.change_price changePrice,
			tsi.car_level carLevel,
			tsi.decision_type decisionType,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tsi.decision_type) decisionTypeName,
			tsi.warehous_date warehousDate,
			tsi.car_series_code carSeriesCode,
			tsi.car_series_name carSeriesName,
			tsi.base_car_type_code baseCarTypeCode,
			tsi.base_car_type_name baseCarTypeName,
			tsi.car_colour carColour,
			tccpr.approve_status approveStatus,
			(case when tccpr.approve_status = 0 then '待审批' when tccpr.approve_status = 1 then '审批通过' when tccpr.approve_status = 2 then '审批驳回' else null end) approveStatusName
		from
			t_psi_car_change_price_record tccpr,
			t_psi_car_stock_info tsi
		where
			tccpr.stock_id = tsi.stock_id
			<if test="approveStatus != null">
			and tccpr.approve_status = #{approveStatus}
			</if>
			<if test="vin != null and vin !='' ">
			and tsi.vin_code like concat('%',#{vin},'%')
			</if>
			<if test="carSeriesCode !=null and carSeriesCode !=''">
			and tsi.car_series_code = #{carSeriesCode}
			</if>
			<if test="baseCarTypeCode !=null and baseCarTypeCode !=''">
			and tsi.base_car_type_code = #{baseCarTypeCode}
			</if>
	</select>
	
	<select id="getCarInfoByVin" resultType="com.exp.ucmp.car.dto.CarMainInfoDto">
		select
			tpsi.stock_id stockId,
			tpsi.product_code productCode,
			tpsi.car_series_code carSeriesCode,
			tpsi.car_series_name carSeriesName,
			tpsi.base_car_type_code baseCarTypeCode,
			tpsi.base_car_type_name baseCarTypeName,
			tpsi.vin_code vin,
			tpsi.interior_color interiorColor,
			tpsi.car_colour vehicleColor,
			tpsi.license_number license,
			tpsi.transfer_count transfersNum,
			date_format(tpsi.first_license_date,'%Y-%m-%d') licensedFirstDate,
			tpsi.license_place licensedCity,
			tpsi.manufacture_date manufactureDate,
			date_format(tpsi.invoicing_date,'%Y-%m-%d') invoiceDate,
			tpsi.stock_mileage showMileage,
			tpsi.battery_capacity batteryCapacity,
			tpsi.comprehensive_range comprehensiveRange,
			tpsi.active_time activeTime,
			tpsi.cur_active_status activeStatus,
			tpsi.new_car_price newCarPrice,
			date_format(tpsi.yearly_inspection_end_date,'%Y-%m-%d') yearlyCheckDueDate,
			date_format(tpsi.accident_insurance_end_date,'%Y-%m-%d') insuranceDueDate,
			tpsi.car_level carLevel,
			tpsi.stock_state stockState
		from
			t_psi_car_stock_info tpsi
		where
			tpsi.repeal_is ='00'
			and tpsi.is_delete = '00'
			and tpsi.stock_id = #{stockId}
	</select>
	
	<select id="queryChangePriceInfo" resultType="com.exp.ucmp.clues.dto.OrderChangePriceDto">
		select
			tccpr.suggested_price suggestedPrice,
			tccpr.cur_price olderPrice,
			tccpr.change_price newPrice,
			tccpr.approve_status approveStatus,
			(case when tccpr.approve_status = 0 then '待审批' when tccpr.approve_status = 1 then '审批通过' when tccpr.approve_status = 2 then '审批驳回' else null end) approveStatusName,
			tccpr.change_reason changeReasons,
			tccpr.oa_code oaCode,
			tccpr.reject_reason rejectReason,
			tccpr.stock_id stockId
		from
			t_psi_car_change_price_record tccpr
		where
			tccpr.record_id = #{recordId}
			<if test="stockId != null">
			and tccpr.stock_id = #{stockId}
			</if>
	</select>
	
	<select id="queryFileList" resultType="com.exp.ucmp.clues.dto.OrderChangeFileDto">
	select
		tpm.material_id materialId,
		tmf.material_order materialOrder,
		tmf.thumbnail,
		tpm.material_type materialType,
		td.dict_value materialTypeName,
		tfm.file_path fileUrl
	from
		t_psi_change_price_material tpm,
		t_sys_material_file tmf,
		t_sys_file_msg tfm,
		t_sys_datadict td
	where
		tpm.material_id = tmf.material_file_id
		and tmf.file_id = tfm.file_id
		and td.dict_code = tpm.material_type
		and tpm.material_type='3301'
		and (tpm.record_id = #{recordId} or tpm.record_id = (select tccpr.order_record_id from t_psi_car_change_price_record tccpr where tccpr.record_id= #{recordId}))
	</select>
	
	<update id="updateChangeRecordInfo" parameterType="com.exp.ucmp.car.dto.ApproveChangePriceDto">
	update
		t_psi_car_change_price_record tccpr
	set
		tccpr.approve_status = #{approveStatus},
		<if test="rejectReason != null and rejectReason != '' ">
		tccpr.reject_reason = #{rejectReason},
		</if>
		tccpr.updated_by = #{updateBy},
		tccpr.updated_date = now()
	where
		tccpr.record_id = #{recordId}
	</update>
	
	<select id="queryOrderRecordId" resultType="java.lang.Long">
	select
		tccpr.order_record_id
	from
		t_psi_car_change_price_record tccpr
	where
		tccpr.record_id = #{recordId}
	</select>
</mapper>