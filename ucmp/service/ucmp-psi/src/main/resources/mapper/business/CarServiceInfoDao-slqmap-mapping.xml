<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.exp.ucmp.servicing.dao.CarServiceInfoDao">


    <select id="findCarInfoByVinCode" parameterType="java.lang.String"
            resultType="com.exp.ucmp.carService.dto.CarServiceInfoDto">
        SELECT
            si.stock_id AS stockId,
            si.vin_code AS vinCode,
            si.purchase_price AS purchasePrice,
            si.car_type AS carType,
            si.base_car_type_name AS baseCarTypeName,
			si.car_series_name AS carSeriesName,
            si.storage_name AS storageName,
            si.stock_type AS stockType,
            cs.service_number AS serviceNumber,
            cs.start_date AS startDate,
            cs.start_people_id AS startPeopleId,
            cs.service_id AS serviceId
        FROM
	        t_psi_car_stock_info si
	    LEFT JOIN
	        t_psi_car_service_info cs ON si.stock_id = cs.stock_id
	    WHERE
	        si.stock_state != '5106' and (cs.service_state is null  or cs.service_state not in ('5306','5309','5311'))
        AND
            si.vin_code =  #{vinCode}
    </select>

    <select id="findCarServiceInfo" parameterType="java.lang.Long" resultType="com.exp.ucmp.carService.dto.CarServiceInfoDto">
            SELECT
                cs.service_id AS serviceId,
                si.vin_code AS vinCode,
                si.purchase_price AS purchasePrice,
                si.car_type AS carType,
                si.storage_name AS storageName,
                cs.service_number AS serviceNumber,
                cs.start_date AS startDate,
                cs.start_people AS startPeople,
                cs.service_place AS servicePlace,
                cs.place_type AS placeType,
                cs.plan_end_date AS planEndDate
            FROM
                t_psi_car_stock_info si
            INNER JOIN t_psi_car_service_info cs ON si.stock_id = cs.stock_id
            WHERE
                cs.stock_id = #{stockId}
    </select>

    <select id="findApprovalList" parameterType="com.exp.ucmp.carService.dto.CarServiceApprovalListParamDto"
            resultType="com.exp.ucmp.carService.dto.CarServiceApprovalListInfoDto">
            SELECT
                csi.service_id AS serviceId,
                csi.stock_id AS stockId,
                csi.service_number AS serviceNumber,
                si.storage_name AS storageName,
                si.car_source AS carSource,
                si.stock_type AS stockType,
                si.source_batch AS sourceBatch,
                si.revert_body AS revertBody,
                si.vin_code AS vinCode,
                si.decision_type AS decisionType,
                si.car_series_name AS carSeriesName,
                si.base_car_type_name AS baseCarTypeName,
                si.car_colour AS carColour,
                csi.start_date AS startDate,
                csi.start_people AS startPeople,
                csi.single_number AS singleNumber,
                csi.single_number_generate_date AS singleNumberGenerateDate,
                csi.plan_start_date AS planStartDate,
                csi.plan_end_date AS planEndDate,
                csi.feedback_date AS feedbackDate,
                csi.expect_end_time AS expectEndTime,
                csi.service_state AS serviceState
            FROM
                t_psi_car_service_info csi
            INNER JOIN
                t_psi_car_stock_info si
            ON
                csi.stock_id = si.stock_id
            <where>
                si.is_enable = '01'
                <if test="type == 1">
                and single_number is null
                </if>
                <if test="type == 2">
                and single_number is not null
                </if>
                <if test="tabState != null and tabState.length > 0">
                    AND csi.service_state IN
                    <foreach item="item" collection="tabState" separator="," open="(" close=")" index="">
                        #{item}
                    </foreach>
                </if>
                <if test="serviceNumber != null and serviceNumber != ''">
                    AND csi.service_number = #{serviceNumber}
                </if>
                <if test="startPeople != null and startPeople != ''">
                    AND csi.start_people = #{startPeople}
                </if>
                <if test="vinCode != null and vinCode != ''">
                    AND si.vin_code = #{vinCode}
                </if>
                <if test="storageCode != null and storageCode != ''">
                    AND si.storage_code = #{storageCode}
                </if>
                <if test="singleNumber != null and singleNumber != ''">
                    AND csi.single_number = #{singleNumber}
                </if>
                <if test="serviceState != null and serviceState != ''">
                    AND csi.service_state = #{serviceState}
                </if>
                <if test="startDate != null">
                    AND csi.start_date >= #{startDate}
                </if>
                <if test="endDate != null">
                    AND csi.start_date &lt; DATE_ADD(#{endDate},INTERVAL 1 DAY)
                </if>
			order by csi.created_date desc
            </where>
    </select>
    <select id="findCarApproveFileList" parameterType="com.exp.ucmp.carService.dto.CarApproveFileListParamDto"
            resultType="com.exp.ucmp.carService.dto.CarApproveFileListInfoDto">
            SELECT
                csi.service_id AS serviceId,
                csi.stock_id AS stockId,
                csi.service_number AS serviceNumber,
                si.storage_name AS storageName,
                (select dict_value from t_sys_datadict  where dict_code = si.car_source) AS carSource,
                si.source_batch AS sourceBatch,
                si.vin_code AS vinCode,
                (select dict_value from t_sys_datadict  where dict_code = si.revert_body) AS revertBody,
                si.decision_type AS decisionType,
                csi.service_place AS servicePlace,
                csi.start_people AS startPeople,
                csi.warehous_people_id AS warehousPeopleId,
                sd.staff_name AS warehousPeople,
                csi.warehous_date AS warehousDate,
                si.car_series_name AS carSeriesName,
                si.base_car_type_name AS baseCarTypeName,
                si.car_colour AS carColour,
                c.approval_result,
                c.approval_date AS approvalDate,
                tcus.city,
                csi.start_date startDate,
                csi.service_state serviceState,
                (select td.dict_value from t_sys_datadict td where td.dict_code=csi.service_state)serviceStateName
            FROM
                t_psi_car_service_info csi
            INNER JOIN t_psi_car_stock_info si ON csi.stock_id = si.stock_id
            left join t_sys_car_used_storage tcus on si.storage_id = tcus.storage_id
            LEFT JOIN t_sys_staff_details sd ON sd.party_id = csi.warehous_people_id
            LEFT join t_psi_car_service_material_approval_record c on c.material_approval_record_id = csi.material_approval_id
            <where>
                si.is_enable = '01'
                AND csi.service_state in ('5306','5311')
                and csi.wait_acceptance = 1
                <if test="approvalResult == null or approvalResult == ''">
                    AND csi.approval_result is NULL
                </if>
                <if test="approvalResult != null and approvalResult != ''">
                    AND c.approval_result = #{approvalResult}
                </if>
                <if test="vinCode != null and vinCode != ''">
                    AND si.vin_code = #{vinCode}
                </if>
                <if test="carSeriesCode != null and carSeriesCode != ''">
                    AND si.car_series_code = #{carSeriesCode}
                </if>
                <if test="baseCarTypeCode != null and baseCarTypeCode != ''">
                    AND si.base_car_type_code = #{baseCarTypeCode}
                </if>
                <if test="revertBody != null and revertBody.size > 0">
                    and si.revert_body IN
                    (<foreach collection="revertBody" item="sta" separator=",">
                    #{sta}
                    </foreach>)
                </if>
                <if test="storageCode != null and storageCode != ''">
                    AND si.storage_code = #{storageCode}
                </if>
                <if test="warehousStartDate != null">
                    AND csi.warehous_date >= #{warehousStartDate}
                </if>
                <if test="warehousEndDate != null">
                    AND csi.warehous_date &lt;= #{warehousEndDate}
                </if>
                <if test="approvalStartDate != null">
                    AND c.approval_date >= #{approvalStartDate}
                </if>
                <if test="approvalEndDate != null">
                    AND c.approval_date &lt;= #{approvalEndDate}
                </if>
            </where>
    </select>
    
    <select id="findServicingList" resultType="com.exp.ucmp.carService.dto.QueryServiceDto">
    	select
			csi.service_id as serviceId,
			csi.stock_id as stockId,
			csi.service_number as serviceNumber,
			si.storage_name as storageName,
			si.car_source as carSource,
			(select td.dict_value from t_sys_datadict td where td.dict_code = si.car_source) carSourceName,
			si.stock_type as stockType,
			(select td.dict_value from t_sys_datadict td where td.dict_code = si.stock_type) stockTypeName,
			si.source_batch as sourceBatch,
			si.revert_body as revertBody,
			(select td.dict_value from t_sys_datadict td where td.dict_code = si.revert_body) revertBodyName,
			si.vin_code as vinCode,
			si.decision_type as decisionType,
			(select td.dict_value from t_sys_datadict td where td.dict_code = si.decision_type) decisionTypeName,
			csi.start_date as startDate,
			csi.start_people as startPeople,
			csi.plan_complete_date planCompleteDate,
			si.car_series_name as carSeriesName,
			si.base_car_type_name as baseCarTypeName,
			si.car_colour as carColour,
			csi.service_state as serviceState,
			(select td.dict_value from t_sys_datadict td where td.dict_code = csi.service_state) serviceStateName,
			csi.is_settlement isSettlement
		from
			t_psi_car_service_info csi
		inner join t_psi_car_stock_info si on csi.stock_id = si.stock_id
		where csi.is_delete='00' and csi.is_enable='01'
		<if test="serviceNumber != null and serviceNumber !='' ">
		and csi.service_number like concat('%',#{serviceNumber},'%')
		</if>
		<if test="vinCode != null and vinCode !='' ">
		and si.vin_code like concat('%',#{vinCode},'%')
		</if>
		<if test="startPeople != null and startPeople !='' ">
		and csi.start_people like concat('%',#{startPeople},'%')
		</if>
		<if test="storageId != null">
		and si.storage_id = #{storageId}
		</if>
		<if test="startDate != null and startDate != ''">
		and csi.start_date >= date_format(#{startDate},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="endDate != null and endDate != ''">
		and csi.start_date &lt;=date_format(#{startDate},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="serviceState != null and serviceState != ''">
		and csi.service_state = #{serviceState}
		</if>
		<if test="isSettlement != 0 ">
		and csi.is_settlement = #{isSettlement}
		</if>
		order by csi.start_date desc
    </select>
    
    <select id="findServiceDetails" resultType="com.exp.ucmp.carService.dto.QueryServiceDetailsDto">
    	select
			tcsi.service_id serviceId,
			tcsi.stock_id stockId,
			tcsi.service_number serviceNumber,
			tsi.base_car_type_name baseCarTypeName,
			tsi.vin_code vinCode,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tsi.car_type) carTypeName,
			tsi.storage_name storageName,
			tcsi.start_people startPeople,
			tcsi.start_date startDate,
			tcsi.service_place siteName,
			tcsi.expect_end_time expectDeliveryTime,
			tcsi.feedback_date feedbackDate,
			tcsi.quote_order_no quoteOrderNo,
			tcsi.plan_complete_date planCompleteDate,
			tcsi.complete_date completeDate,
			tcsi.warehous_date warehousDate,
            (select staff_name from t_sys_staff_details where party_id = tcsi.warehous_people_id) warehousPeopleName,
			tcsi.quote_order_id quoteOrderId,
			tcsi.service_state serviceState,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tcsi.service_state) serviceStateName,
			tcsi.total_price totalPrice,
			(case when tcsar.approval_result = '00' then 0 
				  when tcsar.approval_result = '01' then 1 
				  when tcsar.approval_result = '02' then 2 
				  else 0 end)approveResult,
			tcsar.approval_remark approveRemark,
			tcsi.work_order_no workOrderNo
		from
			t_psi_car_service_info tcsi
		inner join t_psi_car_stock_info tsi on tcsi.stock_id = tsi.stock_id
		left join t_psi_car_service_approval_record tcsar on tcsi.approval_id = tcsar.record_id
		where
			tcsi.service_id = #{serviceId}
    </select>
    
    <select id="queryProjectList" resultType="com.exp.ucmp.isp.dto.QuoteProjectDto">
    	select
			tsrp.quote_order_id quoteOrderId,
			tsrp.project_id projectId,
			tsrp.repair_project_type_code repairProjectTypeCode,
			tsrp.repair_project_type repairProjectType,
			tsrp.repair_project_code repairProjectCode,
			tsrp.repair_project_name repairProjectName,
			tsrp.time_price timePrice,
			tsrp.differentiate_code differentiateCode,
			tsrp.differentiate differentiate,
			tsrp.is_repair isRepair,
			tsrp.reject_reasons rejectReasons
		from t_psi_car_service_repair_project tsrp
		where tsrp.is_delete = '00'
		and tsrp.is_enable = '01'
		and tsrp.quote_order_id = #{quoteOrderId}
    </select>
    
    <select id="queryComponentList" resultType="com.exp.ucmp.isp.dto.QuoteComponentDto">
    	select
    		tsrpc.project_id projectId,
			tsrpc.component_id componentId,
			tsrpc.component_code componentCode,
			tsrpc.component_name componentName,
			tsrpc.component_price componentPrice,
			tsrpc.differentiate_code differentiateCode,
			tsrpc.differentiate ,
			tsrpc.is_repair isRepair,
			tsrpc.reject_reasons rejectReasons
		from t_psi_car_service_repair_project_component tsrpc
		where tsrpc.is_delete = '00'
		and tsrpc.is_enable = '01'
		and tsrpc.project_id = #{projectId}
    </select>
    
    <select id="queryOtherFeesList" resultType="com.exp.ucmp.isp.dto.QuoteOtherFeesDto">
    select
    	tspof.project_id projectId,
		tspof.other_fees_id otherFeesId,
		tspof.other_fees_code otherFeesCode,
		tspof.other_fees_name otherFeesName,
		tspof.repair_time_code repairTimeCode,
		tspof.repair_time_name repairTimeName,
		tspof.fees,
		tspof.receivable_amount receivableAmount,
		tspof.remark,
		tspof.differentiate_code differentiateCode,
		tspof.differentiate,
		tspof.is_repair isRepair,
		tspof.reject_reasons rejectReasons
	from t_psi_car_service_project_other_fees tspof
	where tspof.is_delete = '00'
	and tspof.is_enable = '01'
	and tspof.project_id = #{projectId}
    </select>
    
    <select id="queryRecordList" resultType="com.exp.ucmp.carService.dto.ServiceApproveRecordDto">
    select
		tsar.record_id recordId,
		tsar.service_id serviceId,
		tsar.approval_date approvalDate,
		tsar.approval_result approvalResult,
		tsar.approval_remark approvalRemark
	from
		t_psi_car_service_approval_record tsar
	where
		tsar.service_id = #{serviceId}
	order by
		tsar.approval_date desc
    </select>
    
    <insert id="addApproveRecord" parameterType="com.exp.ucmp.carService.dto.ServiceApproveRecordDto">
    insert
		into
			t_psi_car_service_approval_record ( record_id,
			service_id,
			approval_date,
			approval_result,
			approval_remark,
			approval_people_id,
			created_by,
			created_date,
			updated_by,
			updated_date )
		values( #{recordId},
		#{serviceId},
		current_timestamp,
		#{approvalResult},
		#{approvalRemark},
		#{approvalPeopleId},
		#{createdBy},
		current_timestamp,
		#{updateBy},
		current_timestamp )
    </insert>
    
    <update id="updateProject" parameterType="com.exp.ucmp.carService.dto.QuoteProjectApproveDto">
    update
		t_psi_car_service_repair_project
	set
		is_repair = #{isRepair},
		reject_reasons = #{rejectReasons},
		updated_by = #{updateBy},
		updated_date = current_timestamp
	where
		project_id = #{projectId}
    </update>

	<update id="updateComponent" parameterType="com.exp.ucmp.carService.dto.QuoteComponentApproveDto">
	update
		t_psi_car_service_repair_project_component
	set
		is_repair = #{isRepair},
		reject_reasons = #{rejectReasons},
		updated_by = #{updateBy},
		updated_date = current_timestamp
	where
		component_id = #{componentId}
	</update>
	
	<update id="updateOtherFees" parameterType="com.exp.ucmp.carService.dto.QuoteOtherFeesApproveDto">
	update
		t_psi_car_service_project_other_fees
	set
		is_repair = #{isRepair},
		reject_reasons = #{rejectReasons},
		updated_by = #{updateBy},
		updated_date = current_timestamp
	where
		other_fees_id = #{otherFeesId}
	</update>
	
	<update id="updateServiceStatus">
	update
		t_psi_car_service_info tsi
	set
		tsi.service_state = #{status},
		tsi.approval_id = #{recordId},
		tsi.pre_approval_status = #{preApprovalStatus},
		tsi.updated_by = #{partyId},
		tsi.updated_date = current_timestamp
	where
		tsi.service_id = #{serviceId}
	</update>
	
	<update id="updateServiceInfo">
		update
			t_psi_car_service_info tcsi
		set
			tcsi.material_approval_id = #{materialApprovalRecordId},
			<if test="approvalResult == '00'">
			tcsi.approval_result = 2,
			</if>
			<if test="approvalResult == '01'">
			tcsi.approval_result = 1,
			</if>
			tcsi.approval_date = now(),
			tcsi.updated_by = #{partyId},
			tcsi.updated_date = now()
		where
			tcsi.service_id = #{serviceId}
	</update>
</mapper>