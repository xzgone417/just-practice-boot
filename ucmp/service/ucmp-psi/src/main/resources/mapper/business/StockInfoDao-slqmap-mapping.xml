<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.exp.ucmp.inventory.dao.StockInfoDao">

    <select id="queryStockInfo" resultType="com.exp.ucmp.stock.dto.CarStorageInfoDto">
		SELECT
			DISTINCT
			(select dict_value from t_sys_datadict  where dict_code = a.stock_type) stockType,
			a.warehous_date warehousDate, 				--  入库时间
			a.refund_warehous_date refundWarehousDate,	--  退款入库时间
			a.deliver_date deliverDate,				--  交付出库时间
			b.storage_name storageName,
			b.storage_address storageAddress,
			b.city,
			b.province,
			(select dict_value from t_sys_datadict  where dict_code = c.service_state) serviceStart --  整备单状态
		FROM
			t_psi_car_stock_info a
			left JOIN t_sys_car_used_storage b ON a.storage_id = b.storage_id
			LEFT JOIN t_psi_car_service_info c
			ON a.stock_id = c.stock_id and c.is_delete = '00' and c.is_enable = '01'
		WHERE
			a.is_enable = '01'
		  	and a.is_delete='00'
		  	and a.stock_id = #{stockId}
	</select>


	 <select id="queryStockBasicInfo" resultType="com.exp.ucmp.stock.dto.CarStockBasicInfoDto">
	SELECT
		a.vin_code vin,
		a.car_series_name carSeriesName,
		a.base_car_type_name baseCarTypeName,
		(select dict_value from t_sys_datadict where dict_code = a.car_nature) carNature,
		b.city,
		a.service_time completeDate,
		a.stock_id stockId
		FROM
		t_psi_car_stock_info a
		inner JOIN t_sys_car_used_storage b ON a.storage_id = b.storage_id
		left join t_psi_car_service_info c on a.stock_id = c.stock_id
		WHERE a.is_enable = '01'
		and a.is_delete='00'
		<if test="stockId !=null">
		and a.stock_id = #{stockId}
		</if>
		<if test="vin !=null and vin !='' ">
			and a.vin_code= #{vin}
			<!--已售出车辆查询不到，根据vin查询加上状态条件-->
			and a.stock_state != '5106'
		</if>
	</select>


	<select id="queryFile" resultType="com.exp.ucmp.stock.dto.CarServiceFileDto">
		select
			a.material_id materialId,
			( select dict_value from t_sys_datadict where dict_code = a.material_type ) materialTypeName,
			a.material_type materialType
		from
			t_psi_car_service_material a
		where a.material_type = #{type}
		<if test="serviceId != null">
		  and a.stock_id = (select tcsi.stock_id from t_psi_car_service_info tcsi where tcsi.service_id= #{serviceId})
		</if>
		<if test="stockId != null">
		   and a.stock_id = #{stockId} 
		</if>
		order by a.material_type asc
	</select>

	<select id="queryFileDetail" resultType="com.exp.ucmp.stock.dto.CarServiceFileDetailDto">
		SELECT
			a.material_file_id materialFileId,
			(select dict_value from t_sys_datadict  where dict_code = a.material_file_type) materialFileTypeName,
			a.material_file_type materialFileType,
			a.file_sort fileSort,
			a.reject_reason rejectReason,
			a.chinese_description chineseDescription,
			a.thumbnail,
		    b.file_path AS fileUrl
			FROM t_psi_car_service_material_file a
			left join t_sys_file_msg b ON a.material_file_id = b.file_id
			where a.material_id = #{materialId}
			order by a.file_sort
	</select>

	<select id="queryServicingCompletedList" resultType="com.exp.ucmp.stock.dto.ServicingCompletedDto">
		SELECT
		stock_id stockId,
		storage_id storageId,
		storage_name storageName,
		storage_code storageCode,
		(select dict_value from t_sys_datadict  where dict_code = car_source) carSource,
		source_batch sourceBatch,
		(select dict_value from t_sys_datadict  where dict_code = revert_body) revertBody,
		vin_code vinCode,
		(select dict_value from t_sys_datadict  where dict_code = decision_type) decisionType,
		car_series_name carSeriesName,
		base_car_type_name baseCarTypeName,
		<if test="type == 1">
			(case when (select count(*) from t_psi_mainteance_items where vin_code = a.vin_code) > 0 then '002'
			else '001' end) type,
		</if>
		(select dict_value from t_sys_datadict  where dict_code = stock_state) stockStateName,
		stock_state stockState
	FROM
		t_psi_car_stock_info a
	WHERE
		a.is_enable = '01'
		AND a.is_delete = '00'
		<if test="type == 1"> --  可调整
			and stock_state in ('5103','5104','5105','5107')
		</if>
		<if test="type == 2"> --  已售出
			and stock_state in ('5106')
		</if>
		<if test="vinCode != null and vinCode != ''">
			AND vin_code =#{vinCode}
		</if>
		<if test="storageCode != null and storageCode != ''">
			AND storage_code =#{storageCode}
		</if>
		<if test="carSeriesName != null and carSeriesName != ''">
			AND car_series_name =#{carSeriesName}
		</if>
		<if test="baseCarTypeName != null and baseCarTypeName != ''">
			AND base_car_type_name =#{baseCarTypeName}
		</if>
		<if test="revertBody != null and revertBody != ''">
			AND revert_body =#{revertBody}
		</if>
	</select>


	<select id="queryMainteanceList" resultType="com.exp.ucmp.stock.dto.MaintenceListDto">
		-- 接口表未提供，sql待补充
	</select>
	
	<select id="getCollectFees" resultType="com.exp.ucmp.stock.dto.QueryMaintenceResultDto">
		SELECT td.dict_code collectFees,td.dict_value collectFeesName FROM t_sys_datadict td where td.dict_tag='26'
	</select>

	<select id="queryAdjustMainteanceList" resultType="com.exp.ucmp.stock.dto.SaveMaintenceParamDto">
		select
			stock_id stockId,
			vin_code vinCode,
			project_no projectNo,
			project_name projectName,
			part_code partCode,
			part_name partName,
			work_order_time workOrderTime,
			fee_type feeType,
			fee_type_label feeTypeLabel,
			collect_fees collectFees,
			( select td.dict_value from t_sys_datadict td where td.dict_code = collect_fees ) collectFeesName,
			date_format( maintain_time, '%Y-%m-%d' ) maintainTime,
			date_format( maintain_time, '%Y-%m-%d' ) times,
			maintain_type maintainType
		from
			t_psi_mainteance_items item
		<where>
			<if test="stockId != null">
				and stock_id=#{stockId}
			</if>
			<if test="vin != null and vin != ''">
				and vin_code=#{vin}
			</if>
			<if test="type == 1">
				and maintain_type = '001'
			</if>
			<if test="type == 2">
				and maintain_type = '002'
			</if>
			<if test="maintainType != null">
				and collect_fees = #{maintainType}
			</if>
		</where>
	</select>


	<select id="queryCarStockGroundingList" resultType="com.exp.ucmp.stock.dto.CarStockGroundingDto">
		SELECT
		a.stock_id stockId,
		a.vin_code vinCode,
		a.car_series_name carSeriesName,
		a.base_car_type_name baseCarTypeName,
		a.car_colour carColour,
		a.interior_color interiorColor,
		a.sale_price salePrice,
		YEAR(a.first_license_date) licenseYear,
		b.city,
		c.service_id serviceId,
		( CASE WHEN ( SELECT count(*) FROM t_psi_car_option_info WHERE stock_id = a.stock_id ) > 0 THEN '是' ELSE '否' END ) flag,
		(case when a.stock_mileage >100 then a.stock_mileage else 100 end) stockMileage,
		a.battery_capacity batteryCapacity,
		a.item_no itemNo,
		a.first_license_date firstLicenseDate,
		a.right_pack_id rightPackId,
		a.transfer_count transferCount
		FROM
		t_psi_car_stock_info a
		LEFT JOIN t_sys_car_used_storage b on a.storage_id= b.storage_id
		left join t_psi_car_service_info c on a.stock_id = c.stock_id
		where a.stock_state = '5104'
		and a.decision_type='2301'
		and a.is_delete = '00'
		<if test="city != null and city !=''">
			and b.city =#{city}
		</if>
		<if test="carSeriesCode != null and carSeriesCode !=''">
			and a.car_series_code = #{carSeriesCode}
		</if>
		<if test="curStockId != null">
			and a.stock_id != #{curStockId}
		</if>
		<if test="baseCarTypeCode != null and baseCarTypeCode !=''">
			and a.base_car_type_code = #{baseCarTypeCode}
		</if>
		<if test="type != null">
			<if test="type == 1">
				order by a.sale_price asc, a.grounding_time desc
			</if>
			<if test="type == 2">
				order by a.sale_price desc, a.grounding_time desc
			</if>
			<if test="type == 3">
				order by a.stock_mileage asc, a.grounding_time desc
			</if>
			<if test="type == 4">
				order by TIMESTAMPDIFF( MONTH, a.first_license_date, now()) asc, a.grounding_time desc
			</if>
			<if test="type == 5">
				order by a.grounding_time desc
			</if>
		</if>
		<if test="type == null" >
			order by a.grounding_time desc
		</if>
	</select>

	<select id="queryCarStockGroundingDetail" resultType="com.exp.ucmp.stock.dto.CarStockGroundingDetailDto">
		SELECT
     	a.vin_code vin,
     	a.car_series_code carSeriesCode,
     	a.car_series_name carSeriesName,
     	a.base_car_type_code baseCarTypeCode,
		a.base_car_type_name baseCarTypeName,
		a.car_colour carColour,
		a.sale_price salePrice,
		a.first_license_date firstLicenseDate,
		(case when a.stock_mileage >100 then a.stock_mileage else 100 end) stockMileage,
		a.battery_capacity batteryCapacity,
		b.city,
		a.accident_insurance_end_date accidentInsuranceEndDate,
		a.yearly_inspection_end_date yearlyInspectionEndDate,
		a.new_car_price as guidePrice,
		a.comprehensive_range as comprehensiveRange,
		a.stock_mileage as performanceMileage,
		a.right_pack_id rightPackId,
		a.transfer_count transferCount,
		a.invoicing_date invoiceDate
		FROM
			t_psi_car_stock_info a
			LEFT JOIN t_sys_car_used_storage b ON a.storage_id = b.storage_id
		WHERE
			a.stock_id = #{stockId}
	</select>

	<select id="getRightList" resultType="com.exp.ucmp.stock.dto.CarRightDto">
		SELECT
			b.equity_id equityId,
			b.right_name rightName
		FROM
		t_sys_right_activities a
		join t_sys_right_activities_details b on a.right_id = b.right_id
		where a.is_enable = '01'
		  and a.is_delete = '00'
		  and start_date &lt;> NOW()
		  and end_date >= NOW()
		  and a.right_id = #{rightPackId}
	</select>

	<select id="selectRepairTime" resultType="String">
		SELECT
			created_date
		FROM
			t_psi_car_service_repair_project
		WHERE
			service_id = #{serviceId}
		ORDER BY
			created_date asc
			LIMIT 1
	</select>

	<select id="selectBySelective" parameterType="com.exp.ucmp.entity.PsiCarServiceInfoEntity" resultMap="psiCarServiceInfoResultMap">
		SELECT
		<include refid="t_psi_car_service_info_Column_List" />
		FROM
		    t_psi_car_service_info a
		 where
		    a.stock_id = #{stockId, jdbcType=BIGINT}
	</select>
	<sql id="t_psi_car_service_info_Column_List" >
		a.service_id,
    a.stock_id,
    a.service_place,
    a.service_place_code,
    a.place_type,
    a.place_type_code,
    a.plan_start_date,
    a.plan_end_date,
    a.estimated_delivery_time,
    a.service_number,
    a.start_date,
    a.expect_end_time,
    a.start_people_id,
    a.start_people,
    a.feedback_date,
    a.plan_repair_start_date,
    a.plan_repair_end_date,
	a.service_state,
    a.total_price,
    a.single_number,
    a.single_number_generate_date,
    a.single_number_feedback_date,
    a.plan_complete_date,
    a.complete_date,
    a.warehous_date,
    a.warehous_people_id,
    a.approval_result,
    a.approval_date,
    a.created_by,
    a.created_date,
    a.updated_by,
    a.updated_date,
    a.is_enable,
    a.is_delete
	</sql>

	<resultMap id="psiCarServiceInfoResultMap" type="com.exp.ucmp.entity.PsiCarServiceInfoEntity" >
		<constructor>
			<idArg column="service_id" javaType="Long" jdbcType="BIGINT"/>
		</constructor>
		<result column="stock_id" property="stockId" jdbcType="BIGINT" />
		<result column="service_place" property="servicePlace" jdbcType="VARCHAR" />
		<result column="service_place_code" property="servicePlaceCode" jdbcType="VARCHAR" />
		<result column="place_type" property="placeType" jdbcType="VARCHAR" />
		<result column="place_type_code" property="placeTypeCode" jdbcType="VARCHAR" />
		<result column="plan_start_date" property="planStartDate" jdbcType="TIMESTAMP" />
		<result column="plan_end_date" property="planEndDate" jdbcType="TIMESTAMP" />
		<result column="estimated_delivery_time" property="estimatedDeliveryTime" jdbcType="TIMESTAMP" />
		<result column="service_number" property="serviceNumber" jdbcType="VARCHAR" />
		<result column="start_date" property="startDate" jdbcType="TIMESTAMP" />
		<result column="expect_end_time" property="expectEndTime" jdbcType="TIMESTAMP" />
		<result column="start_people_id" property="startPeopleId" jdbcType="BIGINT" />
		<result column="start_people" property="startPeople" jdbcType="VARCHAR" />
		<result column="feedback_date" property="feedbackDate" jdbcType="TIMESTAMP" />
		<result column="plan_repair_start_date" property="planRepairStartDate" jdbcType="TIMESTAMP" />
		<result column="plan_repair_end_date" property="planRepairEndDate" jdbcType="TIMESTAMP" />
		<result column="service_state" property="serviceState" jdbcType="VARCHAR" />
		<result column="total_price" property="totalPrice" jdbcType="DECIMAL" />
		<result column="single_number" property="singleNumber" jdbcType="VARCHAR" />
		<result column="single_number_generate_date" property="singleNumberGenerateDate" jdbcType="TIMESTAMP" />
		<result column="single_number_feedback_date" property="singleNumberFeedbackDate" jdbcType="TIMESTAMP" />
		<result column="plan_complete_date" property="planCompleteDate" jdbcType="TIMESTAMP" />
		<result column="complete_date" property="completeDate" jdbcType="TIMESTAMP" />
		<result column="warehous_date" property="warehousDate" jdbcType="TIMESTAMP" />
		<result column="warehous_people_id" property="warehousPeopleId" jdbcType="BIGINT" />
		<result column="approval_result" property="approvalResult" jdbcType="VARCHAR" />
		<result column="approval_date" property="approvalDate" jdbcType="TIMESTAMP" />
		<result column="created_by" property="createdBy" jdbcType="BIGINT" />
		<result column="created_date" property="createdDate" jdbcType="TIMESTAMP" />
		<result column="updated_by" property="updatedBy" jdbcType="BIGINT" />
		<result column="updated_date" property="updatedDate" jdbcType="TIMESTAMP" />
		<result column="is_enable" property="isEnable" jdbcType="VARCHAR" />
		<result column="is_delete" property="isDelete" jdbcType="VARCHAR" />
	</resultMap>
	
	<select id="getConfigTopPicUrl" resultType="java.lang.String">
	select
		msg.file_path
	from
		t_sys_config_top_pic pic ,
		t_sys_file_msg msg
	where
		pic.file_id = msg.file_id
		and pic.car_series_code = #{carSeriesCode}
	</select>
	
	<select id="queryTestReportUrl" resultType="java.lang.String">
	select
		tfm.file_path
	from
		t_psi_car_stock_info tsi ,
		t_psi_customer_reservation_track trt,
		t_psi_acquisition_material tam,
		t_sys_material_file tmf,
		t_sys_file_msg tfm
	where
		tsi.source_batch = trt.business_order_no
		and trt.reservation_id =tam.reservation_id
		and tam.material_id = tmf.material_file_id
		and tmf.file_id = tfm.file_id
		and tam.material_type = '9011'
		and tsi.stock_id = #{stockId}
		order by tam.material_type asc,tmf.material_order asc
	</select>
	
</mapper>