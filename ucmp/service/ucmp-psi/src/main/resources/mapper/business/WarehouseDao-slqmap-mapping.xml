<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.exp.ucmp.inventory.dao.WarehouseDao">

    <select id="queryTransferReceipt" resultType="com.exp.ucmp.warehouse.dto.TransferWarehouseResultDto">
        SELECT
            a.base_car_type_name baseCarTypeName,
            a.car_series_name carSeriesName,
            a.car_colour carColour,
            a.stock_type stockType,
        	a.revert_body revertBody,
            (select dict_value from t_sys_datadict  where dict_code = a.stock_type) stockTypeName,
            (select dict_value from t_sys_datadict  where dict_code = a.revert_body) revertBodyName,
            a.vin_code vinCode,
            a.purchase_price purchasePrice,
            b.stock_id stockId,
            b.transfer_apply_id transferApplyId,
            b.dispatch_number dispatchNumber,
            c.storage_name storageName
        FROM
            t_psi_car_stock_info a
                JOIN t_psi_car_transfer_apply b ON a.stock_id = b.stock_id
        LEFT JOIN t_sys_car_used_storage c ON c.storage_id = b.transfer_storage_id
        WHERE
        a.is_delete = '00'
        <if test="storeIds.size>0">
            and c.org_id in(<foreach collection="storeIds" item="sta" separator=",">#{sta}</foreach>)
        </if>
        AND b.transfer_status in ('5205','5206')
        <if test="carSeriesName != null and carSeriesName != ''">
            AND a.car_series_name = #{carSeriesName}
        </if>
        <if test="baseCarTypeName != null and baseCarTypeName != ''">
            AND a.base_car_type_name = #{baseCarTypeName}
        </if>
        <if test="vin != null and vin != ''">
            AND a.vin_code = #{vin}
        </if>
    </select>

    <select id="queryTransferIssue" resultType="com.exp.ucmp.warehouse.dto.TransferWarehouseResultDto">
        SELECT
            a.base_car_type_name baseCarTypeName,
            a.car_series_name carSeriesName,
            a.car_colour carColour,
            a.stock_type stockType,
        	a.revert_body revertBody,
            (select dict_value from t_sys_datadict  where dict_code = a.stock_type) stockTypeName,
            (select dict_value from t_sys_datadict  where dict_code = a.revert_body) revertBodyName,
            a.vin_code vinCode,
            a.purchase_price purchasePrice,
            b.transfer_apply_id transferApplyId,
            c.storage_name storageName
        FROM
            t_psi_car_stock_info a
                JOIN t_psi_car_transfer_apply b ON a.stock_id = b.stock_id
        LEFT JOIN t_sys_car_used_storage c ON c.storage_id = b.storage_id
        WHERE
        a.is_delete = '00'
        <if test="storeIds != null and storeIds.size>0">
            and c.org_id in(<foreach collection="storeIds" item="sta" separator=",">#{sta}</foreach>)
        </if>
        AND b.transfer_status in ('5202','5203')
        <if test="carSeriesName != null and carSeriesName != ''">
            AND a.car_series_name = #{carSeriesName}
        </if>
        <if test="baseCarTypeName != null and baseCarTypeName != ''">
            AND a.base_car_type_name = #{baseCarTypeName}
        </if>
        <if test="vin != null and vin != ''">
            AND a.vin_code = #{vin}
        </if>
    </select>

    <select id="queryRetailOutbound" resultType="com.exp.ucmp.warehouse.dto.TransferWarehouseResultDto">
        SELECT
        e.order_info_id orderInfoId,
        e.stock_id stockId,
        c.storage_name storageName,
        a.base_car_type_name baseCarTypeName,
        a.car_series_name carSeriesName,
        a.car_colour carColour,
        (select dict_value from t_sys_datadict  where dict_code = a.stock_type) stockTypeName,
        (select dict_value from t_sys_datadict  where dict_code = a.revert_body) revertBodyName,
        a.vin_code vinCode,
        a.purchase_price purchasePrice
        FROM
        t_psi_car_stock_info a
        inner JOIN t_psi_order_info e ON a.stock_id = e.stock_id
        LEFT JOIN t_sys_car_used_storage c ON c.storage_id = a.storage_id
        LEFT JOIN (SELECT stock_id from t_psi_car_stock_history WHERE stock_type = '5403') d ON d.stock_id = a.stock_id
        WHERE
        a.is_delete = '00'
        AND a.decision_type = '2301'
        AND e.order_status = '7406'
        AND d.stock_id is null
        <if test="storeIds.size>0">
            and c.org_id in(<foreach collection="storeIds" item="sta" separator=",">#{sta}</foreach>)
        </if>
        <if test="carSeriesName != null and carSeriesName != ''">
            AND a.car_series_name = #{carSeriesName}
        </if>
        <if test="baseCarTypeName != null and baseCarTypeName != ''">
            AND a.base_car_type_name = #{baseCarTypeName}
        </if>
        <if test="vin != null and vin != ''">
            AND a.vin_code = #{vin}
        </if>
    </select>

    <select id="queryBatchIssue" resultType="com.exp.ucmp.warehouse.dto.TransferWarehouseResultDto">
        SELECT
        b.stock_id stockId,
        b.sale_record_id saleRecordId,
        c.storage_name storageName,
        a.base_car_type_name baseCarTypeName,
        a.car_series_name carSeriesName,
        a.car_colour carColour,
        a.stock_type stockType,
        a.revert_body revertBody,
        (select dict_value from t_sys_datadict  where dict_code = a.stock_type) stockTypeName,
        (select dict_value from t_sys_datadict  where dict_code = a.revert_body) revertBodyName,
        a.vin_code vinCode,
        a.purchase_price purchasePrice
        FROM
        t_psi_car_stock_info a
        JOIN t_psi_car_sale_record b ON a.stock_id = b.stock_id
        LEFT JOIN t_sys_car_used_storage c ON c.storage_id = a.storage_id
        LEFT JOIN (SELECT stock_id from t_psi_car_stock_history WHERE stock_type = '5404') d ON d.stock_id = a.stock_id
        WHERE
        a.is_delete = '00'
        <if test="storeIds.size>0">
            and c.org_id in(<foreach collection="storeIds" item="sta" separator=",">#{sta}</foreach>)
        </if>
        AND d.stock_id is null
        AND a.decision_type = '2302'
        <if test="carSeriesName != null and carSeriesName != ''">
            AND a.car_series_name = #{carSeriesName}
        </if>
        <if test="baseCarTypeName != null and baseCarTypeName != ''">
            AND a.base_car_type_name = #{baseCarTypeName}
        </if>
        <if test="vin != null and vin != ''">
            AND a.vin_code = #{vin}
        </if>
    </select>

    <select id="queryCheckList" resultType="com.exp.ucmp.warehouse.dto.CheckWarehouseResultDto">
        SELECT
        si.service_id AS serviceId,
        si.stock_id AS stockId,
        si.service_number AS serviceNumber,
        si.service_state AS serviceState,
        csi.storage_name AS storageName,
        csi.stock_type AS stockType,
        csi.revert_body AS revertBody,
        (select dict_value from t_sys_datadict  where dict_code = csi.stock_type) stockTypeName,
        (select dict_value from t_sys_datadict  where dict_code = csi.revert_body) revertBodyName,
        csi.vin_code AS vinCode,
        csi.purchase_price AS purchasePrice,
        csi.car_series_name AS carSeriesName,
        csi.base_car_type_name AS baseCarTypeName,
        csi.car_colour AS carColour
        FROM
        t_psi_car_service_info si
        INNER JOIN t_psi_car_stock_info csi ON si.stock_id = csi.stock_id
        WHERE
         1 = 1
        <if test="carSeriesName != null and carSeriesName != ''">
            AND csi.car_series_name = #{carSeriesName}
        </if>
        <if test="baseCarTypeName != null and baseCarTypeName != ''">
            AND csi.base_car_type_name = #{baseCarTypeName}
        </if>
        <if test="vin != null and vin != ''">
            AND csi.vin_code = #{vin}
        </if>
    </select>

    <select id="selectServiceList" resultType="com.exp.ucmp.warehouse.dto.CheckWarehouseResultDto">
        SELECT
            a.base_car_type_name AS baseCarTypeName,
            a.car_series_name AS carSeriesName,
            a.car_colour AS carColour,
            a.stock_type as stockType,
            a.revert_body as revertBody,
            (select dict_value from t_sys_datadict  where dict_code = a.stock_type) stockTypeName,
            (select dict_value from t_sys_datadict  where dict_code = a.revert_body) revertBodyName,
            a.vin_code AS vinCode,
            a.purchase_price AS purchasePrice,
            b.stock_id AS stockId,
            b.service_id AS serviceId,
            b.service_number AS serviceNumber,
            a.storage_name AS storageName
        FROM
            t_psi_car_stock_info a
        INNER JOIN
            t_psi_car_service_info b
        ON a.stock_id = b.stock_id
        INNER JOIN
            t_sys_car_used_storage c
        ON c.storage_id = a.storage_id
        WHERE
            c.org_id = #{orgId}
    </select>

    <select id="selectOrgIdsByPartyId" resultType="java.lang.Long">
            SELECT
                b.org_id
            FROM
                t_sys_store_staff_rela a
                    JOIN t_sys_store_info b ON a.store_id = b.store_id
            WHERE
                a.party_id = #{partyId}
                and b.org_type = '4'
    </select>
    <select id="queryAcquisitionList" resultType="com.exp.ucmp.warehouse.dto.AcquisitionWarehouseResultDto">
        SELECT
            pcsi.source_batch businessOrderNo,
            pcsi.stock_id stockId,
            pcsi.storage_name storageName,
            pcsi.stock_type stockType,
            pcsi.revert_body revertBody,
            (select dict_value from t_sys_datadict  where dict_code = pcsi.stock_type) stockTypeName,
            (select dict_value from t_sys_datadict  where dict_code = pcsi.revert_body) revertBodyName,
            pcsi.vin_code vinCode,
            pcsi.purchase_price purchasePrice,
            pcsi.car_colour carColour,
            pcsi.car_series_name carSeriesName,
            pcsi.base_car_type_name baseCarTypeName
        FROM t_psi_car_stock_info pcsi 
        <where>
           pcsi.car_source = '2102'
            <if test="carSeriesName != null and carSeriesName != ''">
                AND pcsi.car_series_name = #{carSeriesName}
            </if>
            <if test="baseCarTypeName != null and baseCarTypeName != ''">
                AND pcsi.base_car_type_name = #{baseCarTypeName}
            </if>
            <if test="vin != null and vin != ''">
                AND pcsi.vin_code = #{vin}
            </if>
            order by pcsi.warehous_date desc,pcsi.created_date desc
        </where>

    </select>
    
    <update id="updateServiceInfo">
    update
		t_psi_car_service_info tcsi
	set
		tcsi.wait_acceptance = 1,
		tcsi.approval_result = null,
		tcsi.material_approval_id =null,
		tcsi.updated_by = #{updateBy},
		tcsi.updated_date = now()
	where
		tcsi.service_id = #{serviceId}
    </update>
    
    <select id="queryStockId" resultType="java.lang.Long">
    select tcsi.stock_id from t_psi_car_service_info tcsi where tcsi.service_id= #{serviceId}		
    </select>
</mapper>