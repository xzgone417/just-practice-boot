<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.exp.ucmp.storeApp.dao.ReservationDao">

	<resultMap type="com.exp.ucmp.eos.dto.ReservationDto" id="reservationMap">
		<result column="reservation_id" property="trackId" javaType="java.lang.String"/>
		<result column="business_order_no" property="businessOrderNo" javaType="java.lang.String"/>
		<result column="brand_chinese_describe" property="vehicleBrand" javaType="java.lang.String"/>
		<result column="car_series_chinese_describe" property="vehicleSeries" javaType="java.lang.String"/>
		<result column="car_year_chinese_describe" property="vehicleYear" javaType="java.lang.String"/>
		<result column="car_type_chinese_describe" property="vehicleModel" javaType="java.lang.String"/>
		<result column="licensing_city" property="licensedCity" javaType="java.lang.String"/>
		<result column="licensing_date" property="licensedTime" javaType="java.lang.String"/>
		<result column="estimate_deal_price" property="bestPrice" javaType="java.lang.String"/>
		<result column="track_status" property="trackStatus" javaType="java.lang.String"/>
		<result column="dict_value" property="trackStatusDesc" javaType="java.lang.String"/>
		<result column="organization_id" property="organizationId" javaType="java.lang.String"/>
		<result column="department_id" property="departmentId" javaType="java.lang.String"/>
		<result column="customer_expect_price" property="expectedPrice" javaType="java.lang.String"/>
		<result column="reservation_detection_address" property="detectionLocation" javaType="java.lang.String"/>
		<result column="reservation_detection_date" property="detectionTime" javaType="java.lang.String"/>
	</resultMap>

    <select id="reservationList" resultType="com.exp.ucmp.eos.dto.ReservationDto" parameterType="com.exp.ucmp.eos.dto.ReservationParamDto">
    select
		ta.*,
		trm.customer_expect_price expectedPrice,
		trm.reservation_detection_address detectionLocation,
		trm.reservation_detection_date detectionTime
	from
		(
		select
			trt.reservation_id trackId,
			trt.business_order_no businessOrderNo,
			tcc.brand_chinese_describe vehicleBrand,
			tcc.car_series_chinese_describe vehicleSeries,
			tcc.car_year_chinese_describe vehicleYear,
			tcc.car_type_chinese_describe vehicleModel,
			tcc.licensing_city licensedCity,
			tcc.licensing_date licensedTime,
			trt.estimate_deal_price bestPrice,
			trt.track_status trackStatus,
			td.dict_value trackStatusDesc,
			tai.organization_id organizationId,
			tai.department_id departmentId
		from
			t_psi_customer_reservation_track trt,
			t_psi_customer_cars tcc,
			t_sys_datadict td,
			t_psi_customer_basic_information tci,
			t_psi_create_order_account_info tai
		where
			trt.reservation_id = tcc.reservation_id
		  	AND trt.is_delete != '00'
			and trt.track_status = td.dict_code
			and td.dict_status = 01
			and trt.info_id = tai.info_id
			and trt.customer_id = tci.customer_id
			and tci.uid = #{uid} ) ta
	left join t_psi_customer_reservation_msg trm on
		ta.trackId = trm.reservation_id
    </select>
    
    <select id="queryPartyId" resultType="java.lang.Long">
    	select
			tum.party_id
		from
			t_sys_store_staff_user_mapping tum
		where
			tum.user_id = #{userId}
		union select
			tsi.party_id
		from
			t_sys_store_staff_info tsi
		where
			tsi.user_id = #{userId}
    </select>
    
    <select id="queryStoreId" resultType="java.lang.Long">
    	select tsi.store_id from t_sys_store_info tsi where tsi.org_id = #{departmentId}
    </select>
    
    <select id="countUnAllocatedNum" resultType="java.lang.Integer">
    	select
			count(tdi.inquiry_id)
		from
			t_psi_car_dealer_inquiry tdi ,
			t_psi_car_acquisition tca
		where
			tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.inquiry_status = '0921'
			and tca.acquisition_status = '1106'
			and tdi.acquisition_store_id = #{storeId}
    </select>
    
    <select id="countUnAcquisitionNum" resultType="java.lang.Integer">
    	select
			count(tdi.inquiry_id)
		from
			t_psi_car_dealer_inquiry tdi ,
			t_psi_car_acquisition tca
		where
			tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.inquiry_status = '0921'
			and tca.acquisition_status = '1101'
			and tca.approval_status is null
			and tdi.acquisition_store_id = #{storeId}
			<if test="partyId !=null">
			and tdi.acquirer_id = #{partyId}
			</if>
    </select>
    
    <select id="countUnApproveNum" resultType="java.lang.Integer">
    	select
			count(tdi.inquiry_id)
		from
			t_psi_car_dealer_inquiry tdi ,
			t_psi_car_acquisition tca
		where
			tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.inquiry_status = '0921'
			and tca.acquisition_status = '1101'
			and tca.approval_status = '1303'
			and tdi.acquisition_store_id = #{storeId}
			<if test="partyId !=null">
			and tdi.acquirer_id = #{partyId}
			</if>
    </select>
    
    <select id="countApprovalRejectionNum" resultType="java.lang.Integer">
    	select
			count(tdi.inquiry_id)
		from
			t_psi_car_dealer_inquiry tdi ,
			t_psi_car_acquisition tca
		where
			tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.inquiry_status = '0921'
			and tca.acquisition_status = '1101'
			and tca.approval_status = '1305'
			and tdi.acquisition_store_id = #{storeId}
			<if test="partyId !=null">
			and tdi.acquirer_id = #{partyId}
			</if>
    </select>
    
    <select id="countPendingStockNum" resultType="java.lang.Integer">
    	select
			count(tdi.inquiry_id)
		from
			t_psi_car_dealer_inquiry tdi ,
			t_psi_car_acquisition tca
		where
			tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.inquiry_status = '0921'
			and tca.acquisition_status = '1104'
			and tca.approval_status = '1304'
			and tdi.acquisition_store_id = #{storeId}
			<if test="partyId !=null">
			and tdi.acquirer_id = #{partyId}
			</if>
    </select>
    
    <select id="countWarehousedNumm" resultType="java.lang.Integer">
    	select
			count(tdi.inquiry_id)
		from
			t_psi_car_dealer_inquiry tdi ,
			t_psi_car_acquisition tca
		where
			tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.inquiry_status = '0922'
			and tca.acquisition_status = '1105'
			and tca.approval_status in ('1304','1306')
			and tdi.acquisition_store_id = #{storeId}
			<if test="partyId !=null">
			and tdi.acquirer_id = #{partyId}
			</if>
    </select>
    
    <select id="acquisitionList" resultType="com.exp.ucmp.storeApp.dto.OneselfAcquisitionDto" 
    	parameterType="com.exp.ucmp.storeApp.dto.OneselfAcquisitionParamDto">
    	select
    		tdi.inquiry_id inquiryId,
			tdi.reservation_id reservationId,
			tdi.business_order_no businessOrderNo,
			tcc.vin_code vin,
			tdi.customer_name customerName,
			tdi.customer_iphone enCustomerIphone,
			(
			case
				when tdi.inquiry_status = '0921' and tca.acquisition_status in ( '1106', '1101' ) and tca.approval_status is null then tca.acquisition_status
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status in ( '1303', '1305', '1309' ) then tca.approval_status
				when tdi.inquiry_status = '0921' and tca.approval_status = '1304' and tca.acquisition_status = '1104' then tca.acquisition_status
				when tdi.inquiry_status = '0922' and tca.approval_status in ('1304','1306') and tca.acquisition_status = '1105' then tca.acquisition_status
				when tdi.inquiry_status = '0923' then tdi.inquiry_status
			end ) status,
			(
			case
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1106' then '待分配'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status is null then '待收购'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1303' then '待审批'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1305' then '审批驳回'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1309' then '审批关闭'
				when tdi.inquiry_status = '0921' and tca.approval_status = '1304' and tca.acquisition_status = '1104' then '待入库'
				when tdi.inquiry_status = '0922' and tca.approval_status in ('1304','1306') and tca.acquisition_status = '1105' then '已入库待过户'
				when tdi.inquiry_status = '0923' then '已完成'
			end ) statusName
		from
			t_psi_car_dealer_inquiry tdi,
			t_psi_customer_cars tcc,
			t_psi_car_acquisition tca
		where
			tdi.reservation_id = tcc.reservation_id
			and tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.acquisition_store_id = #{storeId}
		<if test="isAll == 2">
			and tca.acquirer_id = #{partyId}
		</if>
		<if test="searchWord !=null and searchWord !=''">
			and (tdi.customer_name like #{searchWord} or tdi.customer_iphone = #{customerIphone} or tdi.business_order_no like #{searchWord} or tcc.vin_code like #{searchWord})
		</if>
		<if test="status !=null and status !=''">
			<if test="status == '1106'">
			and tdi.inquiry_status = '0921' and tca.acquisition_status = '1106'
			</if>
			<if test="status == '1101'">
			and tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status is null
			</if>
			<if test="status == '1303'">
			and tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1303'
			</if>
			<if test="status == '1305'">
			and tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1305'
			</if>
			<if test="status == '1309'">
			and tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1309'
			</if>
			<if test="status == '1104'">
			and tdi.inquiry_status = '0921' and tca.approval_status = '1304' and tca.acquisition_status = '1104'
			</if>
			<if test="status == '1105'">
			and tdi.inquiry_status = '0922' and tca.approval_status in ('1304','1306') and tca.acquisition_status = '1105'
			</if>
			<if test="status == '0923'">
			and tdi.inquiry_status = '0923'
			</if>
		</if>
		order by tdi.business_order_no desc
    </select>
    
    <select id="acquirerList" resultType="com.exp.ucmp.storeApp.dto.OneselfAcquirerDto">
    	select
			tssi.party_id partyId,
			tssi.store_id storeId,
			tssi.user_name consultant,
			tssi.phone_number consultantTel
		from
			t_sys_store_staff_info tssi
		where
			tssi.store_id = #{storeId}
			<if test="roleList != null and roleList.size()>0">
			and tssi.role_code in 
			<foreach collection="roleList" index="index" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
			</if>
			<if test="searchWord !=null and searchWord !=''">
			and (tssi.user_name like concat('%',#{searchWord},'%') or tssi.phone_number = #{phoneNumber})
			</if>
    </select>
    
    <select id="countUndoneNum" resultType="java.lang.Integer" parameterType="com.exp.ucmp.storeApp.dto.OneselfAcquirerDto">
    	select
			count(tdi.inquiry_id)
		from
			t_psi_car_dealer_inquiry tdi,
			t_psi_car_acquisition tca
		where
			tdi.inquiry_id = tca.oneself_brand_inquiryid
			and tdi.acquisition_store_id = #{storeId}
			and tca.acquirer_id = #{partyId}
			and (tdi.inquiry_status != '0923' 
			or (tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1309'))
			<!-- and ((tdi.inquiry_status ='0921' and tca.acquisition_status = '1101' and tca.approval_status is null)
			or (tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status in ('1303','1305'))
			or (tdi.inquiry_status = '0921' and tca.acquisition_status ='1104' and tca.approval_status = '1304')
			or (tdi.inquiry_status = '0922' and tca.acquisition_status ='1105' and tca.approval_status = '1304')) -->
    </select>
    
    <select id="check" resultType="int">
		select
			count(tssi.party_id)
		from
			t_sys_store_staff_info tssi
		where
			tssi.party_id = #{partyId}
		and tssi.store_id = (
			select tdi.acquisition_store_id from t_psi_car_dealer_inquiry tdi, t_psi_car_acquisition tca
				where tdi.inquiry_id = tca.oneself_brand_inquiryid and tdi.inquiry_status = '0921' 
				and tca.acquisition_status = '1106' and tdi.inquiry_id = #{inquiryId}
		<if test="roleList != null and roleList.size()>0">		
		and tssi.role_code in 
			<foreach collection="roleList" index="index" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>)		
    </select>
    
    <update id="allotAcquirer">
    	update
			t_psi_car_acquisition tca
		set
			tca.acquisition_status = '1101',
			tca.acquirer_id = #{partyId},
			tca.updated_by = #{updateBy},
			tca.updated_date = now()
		where
			tca.oneself_brand_inquiryid = #{inquiryId}
    </update>
    
    <select id="queryOrderDetails" resultType="com.exp.ucmp.storeApp.dto.OneselfOrderDetailsDto">
    	select
    		tdi.reservation_id reservationId,
			tdi.customer_name customerName,
			tdi.customer_iphone enCustomerIphone,
			tdi.business_order_no businessOrderNo,
			(
			case
				when tdi.inquiry_status = '0921' and tca.acquisition_status in ( '1106', '1101' ) and tca.approval_status is null then tca.acquisition_status
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status in ( '1303', '1305', '1309' ) then tca.approval_status
				when tdi.inquiry_status = '0921' and tca.approval_status = '1304' and tca.acquisition_status = '1104' then tca.acquisition_status
				when tdi.inquiry_status = '0922' and tca.approval_status in ('1304','1306') and tca.acquisition_status = '1105' then tca.acquisition_status
				when tdi.inquiry_status = '0923' then tdi.inquiry_status
			end ) status,
			(
			case
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1106' then '待分配'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status is null then '待收购'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1303' then '待审批'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1305' then '审批驳回'
				when tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tca.approval_status = '1309' then '审批关闭'
				when tdi.inquiry_status = '0921' and tca.approval_status = '1304' and tca.acquisition_status = '1104' then '待入库'
				when tdi.inquiry_status = '0922' and tca.approval_status = '1304' and tca.acquisition_status = '1105' then '已入库待过户'
				when tdi.inquiry_status = '0923' and tca.approval_status = '1304' and tca.acquisition_status = '1105' then '已完成'
			end ) statusName,
			tcc.brand_chinese_describe brandChineseDescribe,
			tcc.car_series_chinese_describe carSeriesChineseDescribe,
			tcc.car_year_chinese_describe carYearChineseDescribe,
			tcc.car_type_chinese_describe carTypeChineseDescribe,
			tcc.license_plate_num licensePlateNum,
			tcc.vin_code vin,
			tcc.licensing_date licensingDate,
			tcc.color,
			tcc.transfer_times transferTimes,
			(select td.dict_value from t_sys_datadict td where td.dict_code=tcc.using_nature) usingNature,
			tcc.driving_mileage drivingMileage,
			DATE_FORMAT(tca.estimated_transfer_time, '%Y-%m-%d') estimatedTransferTime,
			tcus.storage_id storageId,
			tcus.storage_name storageName
		from
			t_psi_car_acquisition tca 
			inner join t_psi_car_dealer_inquiry tdi on tca.oneself_brand_inquiryid = tdi.inquiry_id
			inner join t_psi_customer_cars tcc on tdi.reservation_id = tcc.reservation_id
			left join t_sys_car_used_storage tcus on tca.storage_id = tcus.storage_id
		where
			tca.oneself_brand_inquiryid = #{inquiryId}
			<if test="isAll == null">
			and tca.acquirer_id = #{partyId}
			</if>
    </select>
    
    <select id="queryPic" resultType="com.exp.ucmp.storeApp.dto.OneselfCarPicDto">
    select
		tam.material_id materialId,
		tmf.material_order materialOrder,
		tmf.thumbnail,
		tam.material_type materialType,
		td.dict_value materialTypeName,
		tfm.file_path fileUrl
	from
		t_psi_acquisition_material tam,
		t_sys_material_file tmf,
		t_sys_file_msg tfm,
		t_sys_datadict td
	where
		tam.material_id = tmf.material_file_id
		and tmf.file_id = tfm.file_id
		and td.dict_code = tam.material_type
		<if test="typeList != null">
		and tam.material_type in 
		<foreach collection="typeList" index="index" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="tag !=null">
		and td.dict_tag = #{tag}
		</if>
		and tam.reservation_id = #{reservationId}
		order by tam.material_type asc,tmf.material_order asc
    </select>
    
    <update id="updateAcquisitionStatus" parameterType="com.exp.ucmp.storeApp.dto.AcquisitionWarehousingDto">
    	update
			t_psi_car_acquisition tca
		set
			tca.updated_by = #{updateBy},
			tca.updated_date = now(),
			tca.storage_id = #{storageId}
			<if test="estimatedTransferTime != null and estimatedTransferTime !='' ">
			,tca.estimated_transfer_time = STR_TO_DATE(#{estimatedTransferTime}, '%Y-%m-%d')
			</if>
			<if test="operationType == 1">
			,tca.material_status = '1503'
			,tca.acquisition_status = '1101'
			,tca.approval_status = '1303'
			</if>
		where
			tca.reservation_id = #{reservationId}
    </update>
    
    <update id="updateInquiryStatus" parameterType="com.exp.ucmp.storeApp.dto.AcquisitionWarehousingDto">
    update
		t_psi_car_dealer_inquiry tdi
	set
		tdi.updated_by = #{updateBy},
		tdi.updated_date = now()
		<if test="estimatedTransferTime != null and estimatedTransferTime !='' ">
		,tdi.estimated_transfer_time = STR_TO_DATE(#{estimatedTransferTime}, '%Y-%m-%d')
		</if>
		<if test="operationType == 1">
		,tdi.inquiry_status = '0921'
		,tdi.approval_status = '1303'
		</if>
	where
		tdi.reservation_id = #{reservationId}
    </update>
    
    <select id="queryDealPriceEnd" resultType="java.lang.Double">
    	select tca.deal_price_end from t_psi_car_acquisition tca where tca.reservation_id = #{reservationId}
    </select>
    
    <select id="getReason" resultType="java.lang.String">
    select
		trar.approval_remark
	from
		t_rep_replacement_approval_record trar,
		t_rep_replacement_approval tra
	where
		trar.replacement_id = tra.replacement_id
		and tra.reservation_id = #{reservationId}
	order by tra.reservation_id desc,trar.approval_date desc
    </select>
    
    <select id="getReservationId" resultType="java.lang.Long">
    	select tca.reservation_id from t_psi_car_acquisition tca where tca.oneself_brand_inquiryid = #{inquiryId}
    </select>
    
    <delete id="clearAcquisitionMaterial">
    delete
	from
		t_psi_acquisition_material tam
	where
		tam.reservation_id = #{reservationId}
		<if test="type == 1">
		and ( tam.material_type = '9007'
		or tam.material_type like '97%'
		or tam.material_type like '98%'
		or tam.material_type like '99%' )
		</if>
		<if test="type == 2">
		and tam.material_type in ('9002','9003','9004','9012','9013','9014','9005')
		</if>
    </delete>
    
    <select id="countReplaceNum" resultType="int">
    	select count(1) from t_rep_replacement_approval tra where tra.reservation_id = #{reservationId}
    </select>
    
    <update id="updateInquiry">
    update t_psi_car_dealer_inquiry tdi 
       set tdi.inquiry_status='0923',tdi.updated_by=#{updateBy},tdi.updated_date=now() 
     where tdi.reservation_id = #{reservationId}
    </update>
    
    <select id="queryRevertBody" resultType="java.lang.String">
    	select tcc.revert_body from t_psi_customer_cars tcc where tcc.reservation_id = #{reservationId}
    </select>
    
    <select id="queryAlias" resultType="String">
    select
		distinct tssi.idm_account_name
	from
		t_sys_store_staff_info tssi
	where
		tssi.party_id = #{partyId}
    </select>
    
    <select id="queryOrderNum" resultType="String">
    select tdi.business_order_no from t_psi_car_dealer_inquiry tdi where tdi.inquiry_id = #{inquiryId}
    </select>
</mapper>