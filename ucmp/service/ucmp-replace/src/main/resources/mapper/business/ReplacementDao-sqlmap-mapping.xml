<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.exp.ucmp.replacement.dao.ReplacementDao" >

    <resultMap id="repReplacementApprovalResultMap" type="com.exp.ucmp.replacement.dto.RepReplacementApprovalReturnDto" >
        <constructor>
            <idArg column="replacement_id" javaType="Long" jdbcType="BIGINT"/>
        </constructor>
        <result column="reservation_id" property="reservationId" jdbcType="BIGINT" />
        <result column="customer_id" property="customerId" jdbcType="BIGINT" />
        <result column="store_id" property="storeId" jdbcType="BIGINT" />
        <result column="store_name" property="storeName" jdbcType="VARCHAR" />
        <result column="make_order_person_id" property="makeOrderPersonId" jdbcType="VARCHAR" />
        <result column="make_order_person_name" property="makeOrderPersonName" jdbcType="VARCHAR" />
        <result column="business_type" property="businessType" jdbcType="VARCHAR" />
        <result column="business_order_no" property="businessOrderNo" jdbcType="VARCHAR" />
        <result column="business_classify" property="businessClassify" jdbcType="VARCHAR" />
        <result column="old_car_customer_name" property="oldCarCustomerName" jdbcType="VARCHAR" />
        <result column="old_car_customer_iphone" property="oldCarCustomerIphone" jdbcType="VARCHAR" />
        <result column="old_car_model_describe" property="oldCarModelDescribe" jdbcType="VARCHAR" />
        <result column="reporting_date_end" property="reportingDateEnd" jdbcType="TIMESTAMP" />
        <result column="approval_date_end" property="approvalDateEnd" jdbcType="TIMESTAMP" />
        <result column="rights_issue_sign" property="rightsIssueSign" jdbcType="VARCHAR" />
        <result column="old_car_confirm_sign" property="oldCarConfirmSign" jdbcType="VARCHAR" />
        <result column="approval_status" property="approvalStatus" jdbcType="VARCHAR" />
        <result column="created_person_name" property="createdPersonName" jdbcType="VARCHAR" />
        <result column="created_date" property="createdDte" jdbcType="TIMESTAMP" />
		<result column="allotPersonId" property="allotPersonId" jdbcType="BIGINT" />
        <result column="allotPerson" property="allotPerson" jdbcType="VARCHAR" />
    </resultMap>

    <sql id="t_rep_replacement_approval_Column_List" >
    a.replacement_id,
    a.reservation_id,
    a.customer_id,
    a.store_id,
    a.store_name,
    a.make_order_person_id,
    a.make_order_person_name,
    a.business_type,
    a.business_order_no,
    a.business_classify,
    a.old_car_customer_name,
    a.old_car_customer_iphone,
    a.old_car_model_describe,
    a.reporting_date_end,
    a.approval_date_end,
    a.rights_issue_sign,
    a.old_car_confirm_sign,
    a.approval_status,
    a.created_person_name,
    a.created_by,
    a.created_date,
    a.updated_by,
    a.updated_date
    </sql>

    <resultMap id="psiCustomerCarsResultMap" type="com.exp.ucmp.entity.PsiCustomerCarsEntity" >
        <constructor>
            <idArg column="reservation_id" javaType="Long" jdbcType="BIGINT"/>
        </constructor>
        <result column="customer_id" property="customerId" jdbcType="BIGINT" />
        <result column="brand" property="brand" jdbcType="VARCHAR" />
        <result column="brand_chinese_describe" property="brandChineseDescribe" jdbcType="VARCHAR" />
        <result column="car_series" property="carSeries" jdbcType="VARCHAR" />
        <result column="car_series_chinese_describe" property="carSeriesChineseDescribe" jdbcType="VARCHAR" />
        <result column="car_year" property="carYear" jdbcType="VARCHAR" />
        <result column="car_year_chinese_describe" property="carYearChineseDescribe" jdbcType="VARCHAR" />
        <result column="car_type" property="carType" jdbcType="VARCHAR" />
        <result column="car_type_chinese_describe" property="carTypeChineseDescribe" jdbcType="VARCHAR" />
        <result column="licensing_city" property="licensingCity" jdbcType="VARCHAR" />
        <result column="licensing_province" property="licensingProvince" jdbcType="VARCHAR" />
        <result column="licensing_date" property="licensingDate" jdbcType="DATE" />
        <result column="driving_mileage" property="drivingMileage" jdbcType="VARCHAR" />
        <result column="color" property="color" jdbcType="VARCHAR" />
        <result column="license_plate_num" property="licensePlateNum" jdbcType="VARCHAR" />
        <result column="vin_code" property="vinCode" jdbcType="VARCHAR" />
        <result column="transfer_times" property="transferTimes" jdbcType="VARCHAR" />
        <result column="using_nature" property="usingNature" jdbcType="VARCHAR" />
        <result column="created_by" property="createdBy" jdbcType="BIGINT" />
        <result column="created_date" property="createdDate" jdbcType="TIMESTAMP" />
        <result column="updated_by" property="updatedBy" jdbcType="BIGINT" />
        <result column="updated_date" property="updatedDate" jdbcType="TIMESTAMP" />
        <result column="allotPersonId" property="allotPersonId" jdbcType="BIGINT" />
        <result column="allotPerson" property="allotPerson" jdbcType="VARCHAR" />
    </resultMap>

    <sql id="t_psi_customer_cars_Column_List" >
        a.reservation_id,
    a.customer_id,
    a.brand,
    a.brand_chinese_describe,
    a.car_series,
    a.car_series_chinese_describe,
    a.car_year,
    a.car_year_chinese_describe,
    a.car_type,
    a.car_type_chinese_describe,
    a.licensing_city,
    a.licensing_province,
    a.licensing_date,
    a.driving_mileage,
    a.color,
    a.license_plate_num,
    a.vin_code,
    a.transfer_times,
    a.using_nature,
    a.created_by,
    a.created_date,
    a.updated_by,
    a.updated_date
    </sql>

    <select id="selectReplaceApproval" parameterType="com.exp.ucmp.replacement.dto.RepReplacementApprovalDto" 
    	resultMap="repReplacementApprovalResultMap">
       SELECT
        a.replacement_id,
	    a.reservation_id,
	    a.customer_id,
	    a.store_id,
	    a.store_name,
	    a.make_order_person_id,
	    a.make_order_person_name,
	    a.business_type,
	    a.business_order_no,
	    a.business_classify,
	    a.old_car_customer_name,
	    a.old_car_customer_iphone,
	    a.old_car_model_describe,
	    a.reporting_date_end,
	    a.approval_date_end,
	    a.rights_issue_sign,
	    a.old_car_confirm_sign,
	    a.approval_status,
	    a.created_person_name,
	    a.created_by,
	    a.created_date,
	    a.updated_by,
	    a.updated_date,
	    tdi.created_by allotPersonId,
	    (select tpi.person_name from t_person_info tpi where tpi.party_id=tdi.created_by) allotPerson
        FROM t_rep_replacement_approval a
        left join t_psi_car_dealer_inquiry tdi on a.reservation_id = tdi.reservation_id
        left join t_psi_inquiry_cars tic on tdi.inquiry_id=tic.inquiry_id
        WHERE
        a.is_delete != '00'
        and a.store_id in (select store_id from t_sys_store_staff_rela where party_id = #{partyId, jdbcType=BIGINT})
        and a.reservation_id in( SELECT f.reservation_id FROM t_psi_new_car_order f)
        <if test="oldCarCustomerName!=null and oldCarCustomerName!=''">
            and a.old_car_customer_name like concat('%',#{oldCarCustomerName, jdbcType=VARCHAR},'%')
        </if>
        <if test="oldCarCustomerIphone!=null and oldCarCustomerIphone!=''">
            and a.old_car_customer_iphone = #{oldCarCustomerIphone, jdbcType=VARCHAR}
        </if>
        <if test="makeOrderPersonName !=null and makeOrderPersonName!=''">
            and a.make_order_person_name like concat('%',#{makeOrderPersonName, jdbcType=VARCHAR},'%')
        </if>
        <if test="createdDateStart!=null and createdDateStart!=''">
            and a.created_date &gt;=#{createdDateStart, jdbcType=TIMESTAMP}
        </if>
        <if test="createdDateEnd!=null and createdDateEnd!=''">
            and a.created_date &lt;DATE_ADD(#{createdDateEnd, jdbcType=TIMESTAMP},INTERVAL 1 DAY)
        </if>
        <if test="approvalDateStart!=null and approvalDateStart!=''">
            and a.approval_date_end &gt;= #{approvalDateStart, jdbcType=TIMESTAMP}
        </if>
        <if test="approvalDateEnd!=null and approvalDateEnd!=''">
            and a.approval_date_end &lt;DATE_ADD(#{approvalDateEnd,jdbcType=TIMESTAMP},INTERVAL 1 DAY)
        </if>
        <if test="businessType!=null and businessType!=''">
            and a.business_type = #{businessType, jdbcType=VARCHAR}
        </if>
        <if test="storeId!=null">
            and a.store_id = #{storeId, jdbcType=BIGINT}
        </if>
        <if test="approvalStatus!=null and approvalStatus!=''">
            and a.approval_status = #{approvalStatus, jdbcType=VARCHAR}
        </if>
        <if test="businessOrderNo != null and businessOrderNo != '' ">
        	and a.business_order_no like concat('%',#{businessOrderNo},'%')
        </if>
        <if test="vinCode != null and vinCode != '' ">
        	and tic.vin_code like concat('%',#{vinCode},'%')
        </if>
        <if test="licensePlateNum != null and licensePlateNum != '' ">
        	and tic.license_plate_num like concat('%',#{licensePlateNum},'%')
        </if>
        order by a.created_date desc
    </select>

    <select id="selectOldConfirm"  resultMap="repReplacementApprovalResultMap" 
    	parameterType="com.exp.ucmp.replacement.dto.RepReplacementApprovalDto">
        SELECT
        	a.replacement_id,
		    a.reservation_id,
		    a.customer_id,
		    a.store_id,
		    a.store_name,
		    a.make_order_person_id,
		    a.make_order_person_name,
		    a.business_type,
		    a.business_order_no,
		    a.business_classify,
		    a.old_car_customer_name,
		    a.old_car_customer_iphone,
		    a.old_car_model_describe,
		    a.reporting_date_end,
		    a.approval_date_end,
		    a.rights_issue_sign,
		    a.old_car_confirm_sign,
		    a.approval_status,
		    a.created_person_name,
		    a.created_by,
		    a.created_date,
		    a.updated_by,
		    a.updated_date,
		    tdi.created_by allotPersonId,
		    (select tpi.person_name from t_person_info tpi where tpi.party_id=tdi.created_by) allotPerson
        FROM t_rep_replacement_approval a
        inner join t_psi_car_dealer_inquiry tdi on a.reservation_id = tdi.reservation_id
        where
        a.is_delete != '00'
        and tdi.acquisition_store_id is null
        and a.store_id in (select store_id from t_sys_store_staff_rela where party_id = #{partyId, jdbcType=BIGINT})
        and a.reservation_id not in( SELECT
        f.reservation_id
        FROM
        t_psi_new_car_order f)
            <if test="oldCarCustomerName!=null and oldCarCustomerName!=''">
                and a.old_car_customer_name like concat('%',#{oldCarCustomerName, jdbcType=VARCHAR},'%')
            </if>
            <if test="oldCarCustomerIphone!=null and oldCarCustomerIphone!=''">
                and a.old_car_customer_iphone = #{oldCarCustomerIphone, jdbcType=VARCHAR}
            </if>
            <if test="makeOrderPersonName!=null and makeOrderPersonName!=''">
                and a.make_order_person_name like concat('%',#{makeOrderPersonName, jdbcType=VARCHAR},'%')
            </if>
            <if test="createdDateStart!=null and createdDateStart!=''">
                and a.created_date <![CDATA[ >= ]]>#{createdDateStart, jdbcType=TIMESTAMP}
            </if>
            <if test="createdDateEnd!=null and createdDateEnd!=''">
                and a.created_date <![CDATA[ < ]]>DATE_ADD(#{createdDateEnd, jdbcType=TIMESTAMP},INTERVAL 1 DAY)
            </if>
            <if test="approvalDateStart!=null and approvalDateStart!=''">
                and a.approval_date_end <![CDATA[ >= ]]> #{approvalDateStart, jdbcType=TIMESTAMP}
            </if>
            <if test="approvalDateEnd!=null and approvalDateEnd!=''">
                and a.approval_date_end <![CDATA[ < ]]>DATE_ADD(#{approvalDateEnd,jdbcType=TIMESTAMP},INTERVAL 1 DAY)
            </if>
            <if test="businessType!=null and businessType!=''">
                and a.business_type = #{businessType, jdbcType=VARCHAR}
            </if>
            <if test="storeId!=null">
                and a.store_id = #{storeId, jdbcType=BIGINT}
            </if>
            <if test="approvalStatus!=null and approvalStatus!=''">
                and a.approval_status = #{approvalStatus, jdbcType=VARCHAR}
            </if>
        order by a.created_date desc
    </select>

    <select id="selectOldCar" parameterType="com.exp.ucmp.replacement.dto.PsiCustomerCarsQueryDto" 
    	resultType="com.exp.ucmp.replacement.dto.PsiCustomerCarsDto">
       SELECT
        a.reservation_id reservationId,
	    a.customer_id customerId,
	    a.brand brand,
	    a.brand_chinese_describe brandChineseDescribe,
	    a.car_series carSeries,
	    a.car_series_chinese_describe carSeriesChineseDescribe,
	    a.car_year carYear,
	    a.car_year_chinese_describe carYearChineseDescribe,
	    a.car_type carType,
	    a.car_type_chinese_describe carTypeChineseDescribe,
	    a.licensing_city licensingCity,
	    a.licensing_province licensingProvince,
	    a.licensing_date licensingDate,
	    a.driving_mileage drivingMileage,
	    a.color color,
	    a.license_plate_num licensePlateNum,
	    a.vin_code vinCode,
	    a.transfer_times transferTimes,
	    a.using_nature usingNature,
	    tdi.created_by allotPersonId,
	    (select tpi.person_name from t_person_info tpi where tpi.party_id=tdi.created_by) allotPerson
        FROM t_psi_customer_cars a
        left join t_psi_car_dealer_inquiry tdi on a.reservation_id = tdi.reservation_id
        <trim prefix="WHERE" prefixOverrides="AND" >
            <if test="reservationId != null" >
                    AND a.reservation_id = #{reservationId, jdbcType=BIGINT}
            </if>
        </trim>
    </select>

    <resultMap id="repReplacementMaterialResultMap" type="com.exp.ucmp.replacement.dto.RepReplacementMaterialDto" >
        <constructor>
            <idArg column="material_id" javaType="Long" jdbcType="BIGINT"/>
        </constructor>
        <result column="replacement_id" property="replacementId" jdbcType="BIGINT" />
        <result column="material_type" property="materialType" jdbcType="VARCHAR" />
        <result column="upload_person" property="uploadPerson" jdbcType="BIGINT" />
        <result column="upload_date" property="uploadDate" jdbcType="TIMESTAMP" />
    </resultMap>

    <sql id="t_rep_replacement_material_Column_List" >
        a.material_id,
    a.replacement_id,
    a.material_type,
    a.upload_person,
    a.upload_date
    </sql>

    <select id="selectMaterial" parameterType="com.exp.ucmp.replacement.dto.RepReplacementMaterialQueryDto" resultMap="repReplacementMaterialResultMap">
        SELECT
        <include refid="t_rep_replacement_material_Column_List" />
        FROM t_rep_replacement_material a
        <trim prefix="WHERE" prefixOverrides="AND" >
            <if test="replacementId != null" >
                AND a.replacement_id = #{replacementId, jdbcType=BIGINT}
            </if>
        </trim>
    </select>

    <resultMap id="repReplacementMaterialFileResultMap" type="com.exp.ucmp.entity.RepReplacementMaterialFileEntity" >
        <constructor>
            <idArg column="material_file_id" javaType="Long" jdbcType="BIGINT"/>
        </constructor>
        <result column="material_id" property="materialId" jdbcType="BIGINT" />
        <result column="material_order" property="materialOrder" jdbcType="INTEGER" />
        <result column="upload_person" property="uploadPerson" jdbcType="BIGINT" />
        <result column="upload_date" property="uploadDate" jdbcType="TIMESTAMP" />
        <result column="thumbnail" property="thumbnail" jdbcType="LONGVARCHAR" />
    </resultMap>

    <sql id="t_rep_replacement_material_file_Column_List" >
        a.material_file_id,
    a.material_id,
    a.order,
    a.upload_person,
    a.upload_date,
    a.thumbnail
    </sql>

    <select id="selectMaterialFile" parameterType="com.exp.ucmp.entity.RepReplacementMaterialFileEntity" resultMap="repReplacementMaterialFileResultMap">
        SELECT
        <include refid="t_rep_replacement_material_file_Column_List" />
        FROM t_rep_replacement_material_file a
        <trim prefix="WHERE" prefixOverrides="AND" >
            <if test="materialFileId != null" >
                AND a.material_file_id = #{materialFileId, jdbcType=BIGINT}
            </if>
            <if test="materialId != null" >
                AND a.material_id = #{materialId, jdbcType=BIGINT}
            </if>
            <if test="order != null" >
                AND a.order = #{order, jdbcType=INTEGER}
            </if>
            <if test="uploadPerson != null" >
                AND a.upload_person = #{uploadPerson, jdbcType=BIGINT}
            </if>
            <if test="uploadDate != null" >
                AND a.upload_date = #{uploadDate, jdbcType=TIMESTAMP}
            </if>
            <if test="thumbnail != null" >
                AND a.thumbnail = #{thumbnail, jdbcType=LONGVARCHAR}
            </if>
        </trim>
    </select>

    <select id="selectApprovalHistory" parameterType="com.exp.ucmp.replacement.dto.ApprovalHistoryDto" resultType="com.exp.ucmp.replacement.dto.RepReplacementApprovalRecordDto">
            select
            d.reporting_date AS reportingDate,
            d.approval_person AS approvalPerson,
            d.approval_person_name AS approvalPersonName,
            d.approval_date AS approvalDate,
            d.approval_result AS approvalResult,
            d.approval_remark AS approvalRemark
            from
           t_rep_replacement_approval_record d
            where d.replacement_id = #{replacementId, jdbcType=BIGINT}
            order by d.approval_date desc
    </select>

	<select id="selectReplacementOrder" resultType="com.exp.ucmp.replacement.dto.ReplacementOrderQueryDto">
        SELECT
        a.reservation_id AS reservationId,
        e.customer_name AS customerName,
        e.customer_iphone AS customerIphone,
        a.store_id AS storeId,
        a.make_order_person_name AS makeOrderPersonName,
        a.make_order_person_role AS makeOrderPersonRole,
        a.business_type AS businessType,
        a.business_order_no AS businessOrderNo,
        d.car_type_chinese_describe AS carTypeChineseDescribe,
        a.created_date AS createdDate,
        ( CASE WHEN c.inquiry_status IN ( '0918', '0919', '0929' ) THEN 1 ELSE 0 END ) AS isDefeat,
        (CASE
                WHEN a.track_status = '0701' THEN '待分配'
                WHEN c.inquiry_status = '0901' THEN '待接单'
                WHEN c.inquiry_status = '0911' THEN '待检测'
                WHEN c.inquiry_status = '0921' THEN '待收购'
                WHEN c.inquiry_status = '0922' THEN '待过户'
                WHEN c.approval_status IN ( '1301', '1303' ) THEN '待审批'
                WHEN c.approval_status = '1305' THEN '审批驳回'
                WHEN c.approval_status IN ( '1302', '1304' ) THEN '审批通过'
                WHEN c.inquiry_status = '0909' THEN '放弃接单'
                WHEN c.inquiry_status = '0918' THEN '逾期未报价'
                WHEN c.inquiry_status IN ( '0919', '0929' ) THEN '战败'
                WHEN c.approval_status = '1309' THEN '审批关闭'
            END ) AS approvalName,
        (CASE
                WHEN a.track_status = '0701' THEN a.track_status
                WHEN c.inquiry_status = '0901' THEN c.inquiry_status
                WHEN c.inquiry_status = '0911' THEN c.inquiry_status
                WHEN c.inquiry_status = '0921' THEN c.inquiry_status
                WHEN c.inquiry_status = '0922' THEN c.inquiry_status
                WHEN c.approval_status IN ( '1301', '1303' ) THEN c.approval_status
                WHEN c.approval_status = '1305' THEN c.approval_status
                WHEN c.approval_status IN ( '1302', '1304' ) THEN c.approval_status
                WHEN c.inquiry_status = '0909' THEN c.inquiry_status
                WHEN c.inquiry_status = '0918' THEN c.inquiry_status
                WHEN c.inquiry_status IN ( '0919', '0929' ) THEN c.inquiry_status
                WHEN c.approval_status = '1309' THEN c.approval_status
            END ) AS approvalStatus,
        e.clues_type AS cluesType,
        e.clues_source AS cluesSource,
        (select partner_name from t_sys_partner_details where partner_id = c.car_dealer_id) receivingOrdersDealer,
        c.created_by allotPersonId,
    	(select tpi.person_name from t_person_info tpi where tpi.party_id=c.created_by) allotPerson
        FROM
        t_psi_customer_reservation_track AS a
        JOIN t_psi_customer_cars AS d ON d.reservation_id = a.reservation_id
        JOIN t_psi_customer_basic_information AS e ON e.customer_id = a.customer_id
        LEFT JOIN t_psi_car_dealer_inquiry AS c ON c.reservation_id = a.reservation_id
        WHERE
        a.is_delete != '00'
        and a.business_type='0401'
        and a.store_id in (select store_id from t_sys_store_staff_rela where party_id = #{paramsDto.partyId})
        and a.business_type = #{paramsDto.businessType}
        <if test="paramsDto.storeIds.size>0 ">
            and a.store_id in(<foreach collection="paramsDto.storeIds" item="sta" separator=",">#{sta}</foreach>)
        </if>
        <if test="paramsDto.storeIdsByPartner.size>0 ">
            and a.store_id in(<foreach collection="paramsDto.storeIdsByPartner" item="sta" separator=",">#{sta}</foreach>)
        </if>
        <if test="paramsDto.partnerId !='' and paramsDto.partnerId != null ">
            and c.car_dealer_id = #{paramsDto.partnerId}
        </if>
        <if test="paramsDto.businessOrderNo !='' and paramsDto.businessOrderNo != null">
            and a.business_order_no like concat('%',#{paramsDto.businessOrderNo},'%')
        </if>
        <if test="paramsDto.customerName !='' and paramsDto.customerName != null">
            and e.customer_name like concat('%',#{paramsDto.customerName},'%')
        </if>
        <if test="paramsDto.customerIphone !='' and paramsDto.customerIphone != null">
            and e.customer_iphone = #{paramsDto.customerIphone}
        </if>
        <if test="paramsDto.carTypeChineseDescribe !='' and paramsDto.carTypeChineseDescribe != null">
            and d.car_type_chinese_describe like concat('%',#{paramsDto.carTypeChineseDescribe},'%')
        </if>
        <if test="paramsDto.startDate != null and paramsDto.startDate !=''">
            and a.created_date
                BETWEEN date_format(#{paramsDto.startDate}, '%Y-%m-%d' )
                AND DATE_ADD( date_format( #{paramsDto.endDate} , '%Y-%m-%d' ) ,INTERVAL 1 DAY)
        </if>
        <if test="paramsDto.cluesSource !='' and paramsDto.cluesSource != null">
            and e.clues_source = #{paramsDto.cluesSource}
        </if>
        <if test="paramsDto.makeOrderPersonName !='' and paramsDto.makeOrderPersonName != null">
            and a.make_order_person_name like concat('%',#{paramsDto.makeOrderPersonName},'%')
        </if>
        <if test="paramsDto.storeId !='' and paramsDto.storeId != null">
            and a.store_id = #{paramsDto.storeId}
        </if>
        <if test="paramsDto.trackStatus !='' and paramsDto.trackStatus != null">
            and a.track_status = #{paramsDto.trackStatus}
        </if>
        <if test="paramsDto.inquiryStatus !='' and paramsDto.inquiryStatus != null">
            <if test="paramsDto.inquiryStatus != '0919'">
                and c.inquiry_status = #{paramsDto.inquiryStatus}
            </if>
            <if test="paramsDto.inquiryStatus == '0919'">
                and c.inquiry_status in ('0919','0929')
            </if>
        </if>
        <if test="paramsDto.approvalStatus !='' and paramsDto.approvalStatus != null">
            <if test="paramsDto.approvalStatus == '1302' ">
                and c.approval_status in('1302','1304')
            </if>
            <if test="paramsDto.approvalStatus == '1303' ">
                and c.approval_status in ('1301','1303' )
            </if>
            <if test=" paramsDto.approvalStatus == '1309' or paramsDto.approvalStatus == '1305' ">
                and c.approval_status = #{paramsDto.approvalStatus}
            </if>
        </if>
        ORDER BY a.created_date DESC
    </select>

    <select id="selectReplacementOrderNew" resultType="com.exp.ucmp.replacement.dto.ReplacementOrderQueryDto">
        SELECT
        a.reservation_id AS reservationId,
        e.customer_name AS customerName,
        e.customer_iphone AS customerIphone,
        a.store_id AS storeId,
        a.make_order_person_name AS makeOrderPersonName,
        a.make_order_person_role AS makeOrderPersonRole,
        a.business_type AS businessType,
        a.business_order_no AS businessOrderNo,
        d.car_type_chinese_describe AS carTypeChineseDescribe,
        a.created_date AS createdDate,
        ( CASE WHEN c.inquiry_status IN ( '0909','0919','0929' ) THEN 1 ELSE 0 END ) AS isDefeat,
        (CASE
            WHEN a.track_status = '0701' THEN '已建单'
            WHEN c.inquiry_status = '0901' THEN '待接单'
            WHEN c.inquiry_status = '0909' THEN '已关闭'
            WHEN c.inquiry_status = '0911' THEN '待评估' 
            WHEN c.inquiry_status = '0913' THEN '待分配'
            WHEN c.inquiry_status in ('0919', '0929') THEN '战败'
            WHEN c.inquiry_status = '0921' and ac.acquisition_status in ('1101','1106') and c.approval_status is null THEN '待收购'
            WHEN c.inquiry_status = '0921' and ac.acquisition_status = '1101' and c.approval_status ='1303' THEN '待审批'
            WHEN c.inquiry_status = '0921' and ac.acquisition_status = '1101' and c.approval_status ='1305' THEN '审批驳回'
            WHEN c.inquiry_status = '0921' and ac.acquisition_status = '1101' and c.approval_status ='1309' THEN '审批关闭'
            WHEN c.inquiry_status = '0921' and ac.acquisition_status = '1104' and c.approval_status ='1304' THEN '待入库'
            WHEN c.inquiry_status = '0922' and ac.acquisition_status = '1105' and c.approval_status ='1304' THEN '已入库'
            WHEN c.inquiry_status = '0922' and ac.acquisition_status = '1105' and c.approval_status ='1306' THEN '待发放权益'
            WHEN c.inquiry_status = '0923' and ac.acquisition_status = '1105' and c.approval_status ='1306' THEN '待发放权益'
            WHEN c.inquiry_status = '0923' and ac.acquisition_status = '1105' and c.approval_status ='1304' and tnco.new_car_order_no is null THEN '已入库'
            WHEN c.inquiry_status = '0923' and ac.acquisition_status = '1105' and c.approval_status ='1304' and tra.rights_issue_sign is not null THEN '已完成'
        END ) AS approvalName,
        (CASE
            WHEN a.track_status = '0701' THEN a.track_status
            WHEN c.inquiry_status IN ('0901','0909','0911', '0913','0919', '0929') THEN c.inquiry_status
            WHEN c.inquiry_status = '0921' and ac.acquisition_status in ('1101','1106') and c.approval_status is null THEN c.inquiry_status
            WHEN c.inquiry_status = '0921' and ac.acquisition_status = '1101' and c.approval_status in ('1303','1305','1309') THEN c.approval_status
            WHEN c.inquiry_status = '0921' and ac.acquisition_status = '1104' and c.approval_status ='1304' THEN ac.acquisition_status
            WHEN c.inquiry_status = '0922' and ac.acquisition_status = '1105' and c.approval_status ='1304' THEN ac.acquisition_status
            WHEN c.inquiry_status in ('0922','0923') and ac.acquisition_status = '1105' and c.approval_status ='1306' THEN c.approval_status
            WHEN c.inquiry_status = '0923'  and ac.acquisition_status = '1105' and c.approval_status ='1304' and tnco.new_car_order_no is null THEN ac.acquisition_status
            WHEN c.inquiry_status = '0923'  and ac.acquisition_status = '1105' and c.approval_status ='1304' and tra.rights_issue_sign is not null THEN c.inquiry_status
            END ) AS approvalStatus,
        e.clues_type AS cluesType,
        e.clues_source AS cluesSource,
        (select partner_name from t_sys_partner_details where partner_id = c.car_dealer_id) receivingOrdersDealer,
        c.created_by allotPersonId,
    	(select tpi.person_name from t_person_info tpi where tpi.party_id=c.created_by) allotPerson
        FROM
        t_psi_customer_reservation_track AS a
        JOIN t_psi_customer_cars AS d ON d.reservation_id = a.reservation_id
        JOIN t_psi_customer_basic_information AS e ON e.customer_id = a.customer_id
        LEFT JOIN t_psi_car_dealer_inquiry AS c ON c.reservation_id = a.reservation_id
        left join t_psi_car_acquisition as ac on ac.reservation_id = a.reservation_id
        left join t_rep_replacement_approval tra on a.reservation_id = tra.reservation_id
        left join t_psi_new_car_order tnco on a.reservation_id = tnco.reservation_id
        WHERE
        a.is_delete != '00'
        and a.store_id in (select store_id from t_sys_store_staff_rela where party_id = #{paramsDto.partyId})
        and a.business_type = #{paramsDto.businessType}
        <if test="paramsDto.storeIds.size>0 ">
            and a.store_id in(<foreach collection="paramsDto.storeIds" item="sta" separator=",">#{sta}</foreach>)
        </if>
        <if test="paramsDto.storeIdsByPartner.size>0 ">
            and a.store_id in(<foreach collection="paramsDto.storeIdsByPartner" item="sta" separator=",">#{sta}</foreach>)
        </if>
        <if test="paramsDto.partnerId !='' and paramsDto.partnerId != null ">
            and c.car_dealer_id = #{paramsDto.partnerId}
        </if>
        <if test="paramsDto.businessOrderNo !='' and paramsDto.businessOrderNo != null">
            and a.business_order_no like concat('%',#{paramsDto.businessOrderNo},'%')
        </if>
        <if test="paramsDto.customerName !='' and paramsDto.customerName != null">
            and e.customer_name like concat('%',#{paramsDto.customerName},'%')
        </if>
        <if test="paramsDto.customerIphone !='' and paramsDto.customerIphone != null">
            and e.customer_iphone = #{paramsDto.customerIphone}
        </if>
        <if test="paramsDto.carTypeChineseDescribe !='' and paramsDto.carTypeChineseDescribe != null">
            and d.car_type_chinese_describe like concat('%',#{paramsDto.carTypeChineseDescribe},'%')
        </if>
        <if test="paramsDto.startDate != null and paramsDto.startDate !=''">
            and a.created_date
                BETWEEN date_format(#{paramsDto.startDate}, '%Y-%m-%d' )
                AND DATE_ADD( date_format( #{paramsDto.endDate} , '%Y-%m-%d' ) ,INTERVAL 1 DAY)
        </if>
        <if test="paramsDto.cluesSource !='' and paramsDto.cluesSource != null">
            and e.clues_source = #{paramsDto.cluesSource}
        </if>
        <if test="paramsDto.makeOrderPersonName !='' and paramsDto.makeOrderPersonName != null">
            and a.make_order_person_name like concat('%',#{paramsDto.makeOrderPersonName},'%')
        </if>
        <if test="paramsDto.storeId !='' and paramsDto.storeId != null">
            and a.store_id = #{paramsDto.storeId}
        </if>
       	<if test="paramsDto.status == '0701'">
       		and a.track_status = '0701'
       	</if>
       	<if test="paramsDto.status == '0901'">
            and c.inquiry_status = '0901'
        </if> 
        <if test="paramsDto.status == '0909'">
            and c.inquiry_status = '0909'
        </if>
        <if test="paramsDto.status == '0911'">
        	and c.inquiry_status = '0911'
        </if>    
        <if test="paramsDto.status == '0913'">
        	and c.inquiry_status = '0913'
        </if>
        <if test="paramsDto.status == '0919'">
        	and c.inquiry_status in ('0919', '0929')
        </if>
        <if test="paramsDto.status == '0921'">
        	and c.inquiry_status = '0921' and ac.acquisition_status in ('1101','1106') and c.approval_status is null
        </if>
        <if test="paramsDto.status == '1303'">
        	and c.inquiry_status = '0921' and ac.acquisition_status = '1101' and c.approval_status ='1303'
        </if>
        <if test="paramsDto.status == '1305'">
        	and c.inquiry_status = '0921' and ac.acquisition_status = '1101' and c.approval_status ='1305'
        </if>
        <if test="paramsDto.status == '1309'">
        	and c.inquiry_status = '0921' and ac.acquisition_status = '1101' and c.approval_status ='1309'
        </if>
        <if test="paramsDto.status == '1104'">
        	and c.inquiry_status = '0921' and ac.acquisition_status = '1104' and c.approval_status ='1304'
        </if>
        <if test="paramsDto.status == '1105'">
        	and ((c.inquiry_status = '0922' and ac.acquisition_status = '1105' and c.approval_status ='1304') 
        	or (c.inquiry_status = '0923' and ac.acquisition_status = '1105' and c.approval_status ='1304' and tnco.new_car_order_no is null))
        </if>
        <if test="paramsDto.status == '1306'">
        	and ((c.inquiry_status = '0922' and ac.acquisition_status = '1105' and c.approval_status ='1306')
            or (c.inquiry_status = '0923' and ac.acquisition_status = '1105' and c.approval_status ='1306'))
        </if>
        <if test="paramsDto.status == '0923'">
        	and c.inquiry_status = '0923' and ac.acquisition_status = '1105' and c.approval_status ='1304' and tra.rights_issue_sign is not null
        </if> 
        ORDER BY a.created_date DESC
    </select>
    
    <select id="selectReplacementExportOrderNew" resultType="com.exp.ucmp.replacement.dto.ReplacementOrderExportNewDto">
        select
			t1.customer_name customerName,
			t1.customer_iphone customerIphone,
			t1.staff_code staffCode,
			t1.user_name userName,
			<!-- t1.org_code orgCode, -->
			t1.store_code orgCode,
			t1.org_name orgName,
			date_format(t1.created_date,'%Y-%m-%d %H:%i:%S') createdDate,
			date_format(t1.quote_end_date,'%Y-%m-%d %H:%i:%S') quoteEndDate,
			t1.quote_end_price quoteEndPrice,
			tpcc.car_type_chinese_describe carTypeChineseDescribe,
			(case when length(tpcc.vin_code) != 0 then concat_ws('****',substring(tpcc.vin_code,1,7),substring(tpcc.vin_code,12,17)) else '' end)vinCode,
			tpcc.driving_mileage drivingMileage,
			date_format(t1.first_escalation_time,'%Y-%m-%d %H:%i:%S') firstEscalationTime,
			tpca.deal_price_end dealPriceEnd,
			date_format(t1.second_escalation_time,'%Y-%m-%d %H:%i:%S') secondEscalationTime,
			( select tsd.dict_value from t_sys_datadict tsd where tsd.dict_code = t1.inquiry_status )inquiryStatus,
			t1.partner_abbreviation partnerAbbreviation,
			tpnco.created_date newCarCreatedDate,
			(select tssd.staff_code  from t_sys_staff_details tssd where tssd.party_id=tpnco.created_by)newCarStaffCode,
			(select tssd.staff_name  from t_sys_staff_details tssd where tssd.party_id=tpnco.created_by)newCarStaffName,
			tpnco.new_car_order_no newCarOrderNo,
			(case when trra.rights_issue_sign ='02' then '不发放' when trra.rights_issue_sign ='01' then '发放' else '' end)rightsIssueSign,
			t1.order_abandoned_reason orderAbandonedReason
		from 
			(
			select
				distinct tssd.staff_code,
				(case when tsssi.user_name is not null then tsssi.user_name else tssd.staff_name end)user_name ,
				<!-- tssi.org_code , -->
				tssi.store_code,
				tssi.org_name ,
				tpcdi.created_date,
				tpcdi.reservation_id,
				tpcdi.quote_end_date,
				tpcdi.quote_end_price,
				tpcdi.first_escalation_time,
				tpcdi.customer_intention,
				tpcdi.inquiry_status ,
				tspd.partner_abbreviation ,
				tpcdi.second_escalation_time,
				tpcdi.customer_name,
				tpcdi.customer_iphone,
				tpcdi.order_abandoned_reason 
			from
				t_psi_customer_reservation_track tpcrt
				inner join t_psi_car_dealer_inquiry tpcdi on tpcrt.reservation_id = tpcdi.reservation_id and tpcdi.is_delete = '01'
				left join t_sys_staff_details tssd on tpcdi.created_by = tssd.party_id
				left join t_sys_store_staff_info tsssi on tpcdi.created_by = tsssi.party_id
				left join t_sys_store_info tssi on tpcrt.store_id = tssi.store_id
				left join t_sys_partner_details tspd on tpcdi.car_dealer_id =tspd.partner_id
				where tpcrt.business_type='0401'
				) t1
		left join t_psi_customer_cars tpcc on t1.reservation_id = tpcc.reservation_id
		left join t_psi_car_acquisition tpca on t1.reservation_id = tpca.reservation_id	
		left join t_psi_new_car_order tpnco on t1 .reservation_id = tpnco .reservation_id
		left join t_rep_replacement_approval trra on t1.reservation_id = trra.reservation_id 
			order by t1.created_date desc
    </select>
    
    <!-- 查询门店和客户信息 -->
    <select id="getReplaceDetails" resultType="com.exp.ucmp.replacement.dto.ReplaceDetailsDto">
    	select
			tsi.org_name orgName,
			tai.user_name userName,
			tbi.customer_name customerName,
			tbi.customer_iphone customerIphone,
			tdi.created_by allotPersonId,
			( select tpi.person_name from t_person_info tpi where tpi.party_id = tdi.created_by ) allotPerson,
			trm.reservation_detection_date reservationDetectionDate,
			tdi.acquisition_store_id acquisitionStoreId,
			(select tsi.org_name from t_sys_store_info tsi where tsi.store_id = tdi.acquisition_store_id) acquisitionStoreName,
			tca.acquirer_id acquirerId,
			( select tpi.person_name from t_person_info tpi where tpi.party_id = tca.acquirer_id )acquirerName,
			trt.business_type businessType,
			( CASE WHEN trt.business_type = '0402' and tdi.inquiry_status IN ( '0909','0919','0929' ) THEN 1 ELSE 0 END ) AS isDefeat,
	        (CASE
            WHEN trt.track_status = '0701' THEN '已建单'
            WHEN tdi.inquiry_status = '0901' THEN '待接单'
            WHEN tdi.inquiry_status = '0909' THEN '已关闭'
            WHEN tdi.inquiry_status = '0911' THEN '待评估' 
            WHEN tdi.inquiry_status = '0913' THEN '待分配'
            WHEN tdi.inquiry_status in ('0919', '0929') THEN '战败'
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status in ('1101','1106') and tdi.approval_status is null THEN '待收购'
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tdi.approval_status ='1303' THEN '待审批'
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tdi.approval_status ='1305' THEN '审批驳回'
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tdi.approval_status ='1309' THEN '审批关闭'
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status = '1104' and tdi.approval_status ='1304' THEN '待入库'
            WHEN tdi.inquiry_status = '0922' and tca.acquisition_status = '1105' and tdi.approval_status ='1304' THEN '已入库'
            WHEN tdi.inquiry_status = '0922' and tca.acquisition_status = '1105' and tdi.approval_status ='1306' THEN '待发放权益'
            WHEN tdi.inquiry_status = '0923' and tca.acquisition_status = '1105' and tdi.approval_status ='1306' THEN '待发放权益'
            WHEN tdi.inquiry_status = '0923' and tca.acquisition_status = '1105' and tdi.approval_status ='1304' and tnco.new_car_order_no is null THEN '已入库'
            WHEN tdi.inquiry_status = '0923' and tca.acquisition_status = '1105' and tdi.approval_status ='1304' and tra.rights_issue_sign is not null THEN '已完成'
        END ) AS approvalName,
        (CASE
            WHEN trt.track_status = '0701' THEN trt.track_status
            WHEN tdi.inquiry_status IN ('0901','0909','0911', '0913','0919', '0929') THEN tdi.inquiry_status
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status in ('1101','1106') and tdi.approval_status is null THEN tdi.inquiry_status
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status = '1101' and tdi.approval_status in ('1303','1305','1309') THEN tdi.approval_status
            WHEN tdi.inquiry_status = '0921' and tca.acquisition_status = '1104' and tdi.approval_status ='1304' THEN tca.acquisition_status
            WHEN tdi.inquiry_status = '0922' and tca.acquisition_status = '1105' and tdi.approval_status ='1304' THEN tca.acquisition_status
            WHEN tdi.inquiry_status in ('0922','0923') and tca.acquisition_status = '1105' and tdi.approval_status ='1306' THEN tdi.approval_status
            WHEN tdi.inquiry_status = '0923'  and tca.acquisition_status = '1105' and tdi.approval_status ='1304' and tnco.new_car_order_no is null THEN tca.acquisition_status
            WHEN tdi.inquiry_status = '0923'  and tca.acquisition_status = '1105' and tdi.approval_status ='1304' and tra.rights_issue_sign is not null THEN tdi.inquiry_status
            END ) AS approvalStatus,
            tra.rights_issue_sign rightsIssueSign
		from
			t_psi_customer_reservation_track trt
		inner join t_psi_create_order_account_info tai on trt.info_id = tai.info_id
		inner join t_sys_store_info tsi on tai.department_id = tsi.org_id
		inner join t_psi_customer_basic_information tbi on trt.customer_id = tbi.customer_id
		inner join t_psi_customer_reservation_msg trm on trt.reservation_id = trm.reservation_id	
		left join t_psi_car_dealer_inquiry tdi on trt.reservation_id = tdi.reservation_id
		left join t_psi_car_acquisition tca on trt.reservation_id = tca.reservation_id
		left join t_rep_replacement_approval tra on trt.reservation_id = tra.reservation_id
        left join t_psi_new_car_order tnco on trt.reservation_id = tnco.reservation_id
		where
			trt.is_delete != '00'
			and trt.reservation_id = #{reservationId}
	</select>	
    
    <!-- 查询旧车信息 -->
    <select id="getOldCarInfo" resultType="com.exp.ucmp.replacement.dto.OldCarInfoDto">
    select
		tcc.brand,
		tcc.brand_chinese_describe brandChineseDescribe,
		tcc.car_series carSeries,
		tcc.car_series_chinese_describe carSeriesChineseDescribe,
		tcc.car_year carYear,
		tcc.car_year_chinese_describe carYearChineseDescribe,
		tcc.car_type carType,
		tcc.car_type_chinese_describe carTypeChineseDescribe,
		tcc.vin_code vinCode,
		tcc.license_plate_num licensePlateNum,
		tcc.color color,
		( select tsd.dict_value from t_sys_datadict tsd where tsd.dict_code =  tcc.using_nature) usingNature,
		tcc.transfer_times transferTimes,
		tcc.driving_mileage drivingMileage,
		tcc.licensing_date licensingDate,
		tcc.`rank`,
		tdi.quote_end_price quoteEndPrice
	from
		t_psi_customer_reservation_track trt,
		t_psi_customer_cars tcc,
		t_psi_car_dealer_inquiry tdi
	where
		trt.customer_id = tcc.customer_id
		and trt.reservation_id = tdi.reservation_id
        and trt.is_delete != '00'
		and trt.reservation_id=#{reservationId}
    </select>
    
    <select id="getOldCarInfoNew" resultType="com.exp.ucmp.replacement.dto.OldCarInfoDto">
    select
		tcc.brand,
		tcc.brand_chinese_describe brandChineseDescribe,
		tcc.car_series carSeries,
		tcc.car_series_chinese_describe carSeriesChineseDescribe,
		tcc.car_year carYear,
		tcc.car_year_chinese_describe carYearChineseDescribe,
		tcc.car_type carType,
		tcc.car_type_chinese_describe carTypeChineseDescribe,
		tcc.vin_code vinCode,
		tcc.license_plate_num licensePlateNum,
		tcc.color colorName,
		(select tsd.dict_code from t_sys_datadict tsd where tsd.dict_value =  tcc.color and tsd.dict_tag='80') color,
		tcc.using_nature usingNature,
		(select tsd.dict_value from t_sys_datadict tsd where tsd.dict_code =  tcc.using_nature) usingNatureName,
		tcc.transfer_times transferTimes,
		tcc.driving_mileage drivingMileage,
		tcc.licensing_date licensingDate,
		tcc.`rank`,
		tdi.quote_end_price quoteEndPrice,
		tcc.revert_body revertBody
	from
		t_psi_customer_reservation_track trt 
		inner join t_psi_customer_cars tcc on trt.customer_id = tcc.customer_id
		left join t_psi_car_dealer_inquiry tdi on trt.reservation_id = tdi.reservation_id
	where
		trt.is_delete != '00'
		and trt.reservation_id=#{reservationId}
    </select>
    
    <!-- 接单记录 -->
    <select id="getTakeOrders" resultType="com.exp.ucmp.replacement.dto.TakeOrdersDto">
    select
		tdi.issued_car_dealer_date issuedCarDealerDate,
		tpd.partner_abbreviation partnerAbbreviation,
		tdi.order_receiving_date orderReceivingDate,
		( case
			when tdi.inquiry_status = '0901' then '待接单'
			when tdi.inquiry_status = '0909' then '放弃接单'
			else '已接单'
		end ) inquiryStatus,
        tdi.order_abandoned_reason reason
	from
		t_psi_customer_reservation_track trt,
		t_psi_car_dealer_inquiry tdi,
		t_sys_partner_details tpd
	where
		trt.reservation_id = tdi.reservation_id
        AND trt.is_delete != '00'
		and tdi.car_dealer_id = tpd.partner_id
		and trt.reservation_id = #{reservationId}
    </select>
    
    <!-- 报价记录 -->
    <select id="getQuoteRecord" resultType="com.exp.ucmp.replacement.dto.QuoteRecordDto">
    	select
			t1.partner_abbreviation partnerAbbreviation,
			t1.quote_deadline quoteDeadline,
			t1.order_abandoned_reason reason,
			t1.inquiry_status inquiryStatus,
			tar.appraisal_price appraisalPrice,
			tar.appraisal_date appraisalDate
		from
			( select
				tpd.partner_abbreviation,
				trt.quote_deadline,
				( case
-- 					when tdi.inquiry_status in ( '0902', '0911' ) then '待报价'
					when tdi.inquiry_status ='0919' then '战败'
					when tdi.inquiry_status ='0917' then '报价失效'
					when tdi.inquiry_status = '0918' then '逾期未报价'
					else '已报价'
				end ) inquiry_status,
				tdi.inquiry_id,
				tdi.order_abandoned_reason
			from
				t_psi_customer_reservation_track trt,
				t_psi_car_dealer_inquiry tdi,
				t_sys_partner_details tpd
			where
				trt.reservation_id = tdi.reservation_id
                AND trt.is_delete != '00'
                AND tdi.is_delete != '00'
				and tdi.car_dealer_id = tpd.partner_id
				and tdi.inquiry_status not in ('0901','0909','0902', '0911')
				and trt.reservation_id = #{reservationId}) t1
			left join t_psi_appraisal_record tar ON t1.inquiry_id = tar.inquiry_id
    </select>

	<!-- 收购记录 -->
	<select id="getAcquisitionRecord" resultType="com.exp.ucmp.replacement.dto.AcquisitionRecordDto">
	select
		tpd.partner_abbreviation quoteMerchantsName,
		trt.estimate_deal_price estimateDealPrice,
-- 		(select tsd.dict_value from t_sys_datadict tsd where tsd.dict_code=tca.customer_intention) customerIntention,
        ( case
              when tdi.inquiry_status ='0922' then '是'
              when tdi.inquiry_status ='0923' then '是'
            end )  customerIntention,
-- 		tca.created_date createdDate,
        tdi.first_escalation_time createdDate,
        tdi.order_abandoned_reason reason,
        tdi.second_escalation_time generateAcquisitionsTime,
        ( case
              when tdi.inquiry_status ='0929' then '战败'
              when tdi.inquiry_status ='0922' then '待过户'
              when tdi.inquiry_status = '0923' then '收购完成'
            end ) acquisitionStatus,
		(select tsd.dict_value from t_sys_datadict tsd where tsd.dict_code=tca.approval_status) approvalStatus
	from
		t_psi_customer_reservation_track trt
		JOIN t_psi_car_dealer_inquiry tdi ON trt.reservation_id = tdi.reservation_id
		JOIN t_sys_partner_details tpd ON  tdi.car_dealer_id=tpd.partner_id
        LEFT JOIN t_psi_car_acquisition tca ON trt.reservation_id = tca.reservation_id
	where
        trt.is_delete != '00'
        AND tdi.is_delete != '00'
		and tdi.customer_intention is not null
		and trt.reservation_id = #{reservationId}
        and tdi.inquiry_status in ( '0922' , '0923' ,'0929')
	</select>
    
    <select id="selectApprovalName" resultType="java.lang.String">
        select hhr_name from t_sys_organization_staff_info where rsp_user_info_id = #{partyId}
    </select>

    <select id="selectCodeByValue" resultType="java.lang.String">
        select dict_value from t_sys_datadict where  dict_code= #{code}
    </select>
    
    <select id="queryPic" resultType="com.exp.ucmp.storeApp.dto.OneselfCarPicDto">
    select
		tam.material_id materialId,
		tmf.material_order materialOrder,
		tmf.thumbnail,
		tam.material_type materialType,
		td.dict_value materialTypeName,
		tfm.file_path fileUrl
	from
		t_psi_acquisition_material tam,
		t_sys_material_file tmf,
		t_sys_file_msg tfm,
		t_sys_datadict td
	where
		tam.material_id = tmf.material_file_id
		and tmf.file_id = tfm.file_id
		and td.dict_code = tam.material_type
		<if test="typeList != null">
		and tam.material_type in 
		<foreach collection="typeList" index="index" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		and tam.reservation_id = #{reservationId}
		order by tam.material_type asc,tmf.material_order asc
    </select>

	<update id="updateInquiry" parameterType="com.exp.ucmp.carDealer.dto.SaveTransactionPriceDto">
		update
			t_psi_car_dealer_inquiry tdi
		set
			tdi.deal_price_end = #{dealPriceEnd},
			tdi.updated_by = #{updateBy},
			tdi.updated_date = now()
		where
			tdi.reservation_id = #{reservationId}
	</update>
	
	<update id="updateAcquisition" parameterType="com.exp.ucmp.carDealer.dto.SaveTransactionPriceDto">
		update
			t_psi_car_acquisition tca
		set
			tca.deal_price_end = #{dealPriceEnd},
			tca.updated_by = #{updateBy},
			tca.updated_date = now()
		where
			tca.reservation_id = #{reservationId}
	</update>
	
	<update id="updateAcquisitionStatus" parameterType="com.exp.ucmp.carService.dto.OneselfApproveDto">
    	update
			t_psi_car_acquisition tca
		set
			tca.updated_by = #{updateBy},
			tca.updated_date = now()
			<if test="materialStatus != null">
			,tca.material_status = #{materialStatus}
			</if>
			<if test="approveStatus != null">
			,tca.approval_status = #{approveStatus}
			</if>
			<if test="acquisitionStatus != null">
			,tca.acquisition_status = #{acquisitionStatus}
			</if>
			<if test="dealPriceEnd != null">
			,tca.deal_price_end = #{dealPriceEnd}
			</if>
		where
			tca.reservation_id = #{reservationId}
    </update>
    
    <update id="updateInquiryStatus" parameterType="com.exp.ucmp.carService.dto.OneselfApproveDto">
    update
		t_psi_car_dealer_inquiry tdi
	set
		tdi.updated_by = #{updateBy},
		tdi.updated_date = now(),
		<if test="acquisitionStatus == '1105'">
		tdi.inquiry_status='0922',
		</if>
		<if test="dealPriceEnd != null ">
		tdi.deal_price_end = #{dealPriceEnd},
		</if>
		tdi.approval_status = #{approveStatus}
	where
		tdi.reservation_id = #{reservationId}
    </update>
    
    <update id="updateApprovalStatus" parameterType="com.exp.ucmp.carService.dto.OneselfApproveDto">
    update
		t_rep_replacement_approval tra
	set
		tra.approval_status = #{approveStatus} ,
		<if test="approveStatus =='1302' ">
		tra.approved_time = now(),
		</if>
		tra.approval_date_end = now(),
		<if test="approveStatus =='1309' ">
		tra.close_time = now(),
		</if>
		<if test="approveStatus =='1305' ">
		tra.overrule_time = now(),
		</if>
		tra.updated_by = #{updateBy},
		tra.updated_date = now()
	where
		tra.reservation_id = #{reservationId}
    </update>
    
    <update id="putIntoStorage" parameterType="com.exp.ucmp.carService.dto.OneselfPutIntoStorageDto">
    update
		t_psi_car_acquisition tca
	set
		tca.acquisition_status = '1105' ,
		tca.updated_by = #{updateBy},
		tca.updated_date = now()
	where
		tca.reservation_id = #{reservationId}
    </update>
    
    <update id="updateApproval">
    	update
			t_rep_replacement_approval tra
		set
			tra.grant_benefits_time = now(),
			tra.approval_status = '1304',
			tra.updated_date = now(),
			tra.updated_by = #{partyId}
			<if test="isGrant == 1">
			,tra.rights_issue_sign = '01'
			</if>
			<if test="isGrant != 1">
			,tra.rights_issue_sign = '02'
			</if>
		where
			tra.reservation_id = #{reservationId}
    </update>
    
    <select id="getApprovalId" resultType="java.lang.Long">
    select tra.replacement_id from t_rep_replacement_approval tra where tra.reservation_id = #{reservationId}
    </select>
    
    <select id="getBusinessType" resultType="java.lang.String">
    select trt.business_type from t_psi_customer_reservation_track trt where trt.reservation_id = #{reservationId}
    </select>
    
    <update id="updateInquiryStatusNew" parameterType="com.exp.ucmp.carService.dto.OneselfPutIntoStorageDto">
    update t_psi_car_dealer_inquiry tdi 
       set tdi.inquiry_status='0922',tdi.updated_by=#{updateBy},tdi.updated_date=now()
     where tdi.reservation_id=#{reservationId}
    </update>
    
    <select id="selectNewCarOrderInfo" resultType="com.exp.ucmp.replacement.dto.PsiNewCarOrderDto">
    select
		new_car_id newCarId,
		reservation_id reservationId,
		new_car_vin newCarVin,
		new_car_invoice_no newCarInvoiceNo,
		new_car_order_no newCarOrderNo,
		new_car_delivery_date newCarDeliveryDate,
		owner_name ownerName,
		owner_phone ownerPhone,
		main_user_name mainUserName,
		main_user_phone mainUserPhone,
		car_type newCarModels,
		owner_card_no ownerCardNo
	from
		t_psi_new_car_order tn where tn.reservation_id = #{reservationId}
    </select>
    
    <select id="countCar" resultType="int">
    select count(1) from t_psi_car_stock_info tsi where tsi.repeal_is = '00' and tsi.stock_state != '5106' and tsi.vin_code=#{vinCode}
    </select>
    
    <select id="queryCarInfo" resultType="com.exp.ucmp.replacement.dto.CarStorageInfoDto">
    select
		tca.deal_price_end dealPriceEnd,
		tca.storage_id storageId,
		tcus.storage_name storageName,
		tcus.storage_code storageCode,
		trt.business_order_no businessOrderNo
	from
		t_psi_car_acquisition tca,
		t_sys_car_used_storage tcus,
		t_psi_customer_reservation_track trt
	where
		tca.storage_id = tcus.storage_id
		and tca.reservation_id = trt.reservation_id
		and tca.reservation_id = #{reservationId}
    </select>
    
    <update id="updateCustomerCars" parameterType="com.exp.ucmp.carService.dto.OneselfApproveDto">
	update
		t_psi_customer_cars tcc
	set
		tcc.revert_body = #{revertBody, jdbcType=VARCHAR},
		tcc.updated_by = #{updateBy},
		tcc.updated_date=now()
	where
		tcc.reservation_id = #{reservationId}
	</update>
	
	<select id="queryAlias" resultType="String">
	select
		distinct tssi.idm_account_name
	from
		t_sys_store_staff_info tssi
	where
		tssi.party_id = ( select tca.acquirer_id from t_psi_car_acquisition tca where tca.reservation_id = #{reservationId})
	</select>
	
	<select id="queryOrderNum" resultType="String">
	select tdi.business_order_no from t_psi_car_dealer_inquiry tdi where tdi.reservation_id =#{reservationId}
	</select>
	
	<update id="updateApprovalDel">
		update
			t_rep_replacement_approval tra
		set
			tra.is_delete = '00',
			tra.updated_by = #{partyId},
			tra.updated_date = now()
		where
			tra.reservation_id = #{reservationId} 
	</update>
	
	<select id="getCampaignName" resultType="java.lang.String">
	select
		tadd.campaign_name
	from
		t_sys_right_activities_distribute_details tadd
	where
		tadd.reservation_id = #{reservationId}
	</select>
	
	<select id="getPointsValue" resultType="java.lang.Integer">
	select
		tgpr.points_value
	from
		t_sys_grant_points_record tgpr
	where
		tgpr.reservation_id = #{reservationId}
		order by tgpr.created_date desc limit 1 
	</select>
</mapper>